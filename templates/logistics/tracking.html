{% extends 'base.html' %}

{% block title %}–í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –≤–∞–Ω—Ç–∞–∂—É - FCargos{% endblock %}

{% block extra_css %}
<style>
    body {
        background: #f8f9fa;
    }
    
    .tracking-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1rem 1.25rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        color: white;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    }
    
    .tracking-hero h2 {
        font-size: 1.4rem;
        margin-bottom: 0.25rem;
    }
    
    .tracking-hero p {
        font-size: 0.9rem;
        margin-bottom: 0;
    }
    
    .tracking-main-container {
        display: flex;
        gap: 0.75rem;
        align-items: stretch;
    }
    
    .tracking-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .tracking-card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.6rem 1rem;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .tracking-map-container {
        flex: 1;
        min-height: 450px;
        background: #f8f9fa;
        position: relative;
    }
    
    .tracking-sidebar {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .progress-card {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
    }
    
    .progress-circle {
        width: 100px;
        height: 100px;
        margin: 0 auto 0.75rem;
        position: relative;
    }
    
    .progress-circle svg {
        transform: rotate(-90deg);
    }
    
    .progress-circle-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        font-weight: 700;
        color: #667eea;
    }
    
    .progress-bar-modern {
        height: 12px;
        background: #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
        margin: 1rem 0;
    }
    
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        transition: width 0.5s ease;
        position: relative;
    }
    
    .info-item {
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        border-left: 3px solid #667eea;
    }
    
    .info-item:last-child {
        margin-bottom: 0;
    }
    
    .info-item-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 0.35rem;
    }
    
    .info-item-value {
        font-size: 0.95rem;
        font-weight: 700;
        color: #1e293b;
    }
    
    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .form-control, .form-range {
        font-size: 0.875rem;
    }
    
    .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
    }
    
    @media (max-width: 991px) {
        .tracking-main-container {
            flex-direction: column;
        }
        
        .tracking-map-container {
            min-height: 350px;
        }
        
        .tracking-sidebar {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="tracking-hero">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-radar"></i> –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –≤–∞–Ω—Ç–∞–∂—É
                </h2>
                <p class="mb-0 opacity-75">
                    <i class="bi bi-route"></i> {{ route.origin_city }} ‚Üí {{ route.destination_city }}
                </p>
            </div>
            <span class="badge bg-light text-dark fs-6">
                <i class="bi bi-truck"></i> {{ route.get_status_display }}
            </span>
        </div>
    </div>
    
    <div class="tracking-main-container">
        <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ - –ö–∞—Ä—Ç–∞ -->
        <div style="flex: 2; min-width: 0;">
            <div class="tracking-card" style="height: 100%;">
                <div class="tracking-card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-map"></i> –ö–∞—Ä—Ç–∞ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è
                    </h5>
                </div>
                <div id="trackingMap" class="tracking-map-container"></div>
            </div>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="tracking-sidebar" style="flex: 1; min-width: 0;">
            <!-- –ü—Ä–æ–≥—Ä–µ—Å -->
            <div class="progress-card">
                <h6 class="mb-2 text-center" style="font-weight: 700; font-size: 0.9rem;">
                    <i class="bi bi-speedometer2"></i> –ü—Ä–æ–≥—Ä–µ—Å
                </h6>
                <div class="progress-circle">
                    <svg width="100" height="100">
                        <circle cx="50" cy="50" r="45" stroke="#e2e8f0" stroke-width="6" fill="none"/>
                        <circle cx="50" cy="50" r="45" stroke="#667eea" stroke-width="6" fill="none"
                                stroke-dasharray="{{ tracking.progress_percent|floatformat:0 }} 283"
                                stroke-dashoffset="0"
                                stroke-linecap="round"/>
                    </svg>
                    <div class="progress-circle-text">
                        {{ tracking.progress_percent }}%
                    </div>
                </div>
                <div class="progress-bar-modern">
                    <div class="progress-bar-fill" style="width: {{ tracking.progress_percent }}%;"></div>
                </div>
                <div class="text-center">
                    <small class="text-muted" style="font-size: 0.7rem;">
                        <i class="bi bi-clock-history"></i> {{ tracking.last_update|date:"d.m.Y H:i" }}
                    </small>
                </div>
            </div>
            
            <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
            <div class="tracking-card" style="flex: 1;">
                <div class="tracking-card-header">
                    <h6 class="mb-0" style="font-size: 0.9rem;">
                        <i class="bi bi-info-circle"></i> –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
                    </h6>
                </div>
                <div class="card-body" style="flex: 1; overflow-y: auto; padding: 1rem;">
                    <div class="info-item">
                        <div class="info-item-label">
                            <i class="bi bi-pin-map"></i> –ü–æ—Ç–æ—á–Ω–∞ –ª–æ–∫–∞—Ü—ñ—è
                        </div>
                        <div class="info-item-value">
                            {{ tracking.current_location }}
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-item-label">
                            <i class="bi bi-route"></i> –ú–∞—Ä—à—Ä—É—Ç
                        </div>
                        <div class="info-item-value">
                            <span class="badge bg-success">{{ route.origin_city }}</span>
                            <i class="bi bi-arrow-right mx-2 text-muted"></i>
                            <span class="badge bg-danger">{{ route.destination_city }}</span>
                        </div>
                    </div>
                    
                    {% if route.cargo_type %}
                    <div class="info-item">
                        <div class="info-item-label">
                            <i class="bi bi-box-seam"></i> –í–∞–Ω—Ç–∞–∂
                        </div>
                        <div class="info-item-value">
                            <div class="mb-1">
                                <span class="badge bg-primary">{{ route.cargo_type }}</span>
                            </div>
                            {% if route.weight %}
                            <small class="text-muted d-block">
                                <i class="bi bi-speedometer2"></i> {{ route.weight }} –∫–≥
                            </small>
                            {% endif %}
                            {% if route.volume %}
                            <small class="text-muted d-block">
                                <i class="bi bi-box"></i> {{ route.volume }} –º¬≥
                            </small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è -->
            {% if can_update and form %}
            <div class="tracking-card">
                <div class="tracking-card-header">
                    <h6 class="mb-0" style="font-size: 0.9rem;">
                        <i class="bi bi-sliders"></i> –û–Ω–æ–≤–∏—Ç–∏
                    </h6>
                </div>
                <div class="card-body" style="padding: 1rem;">
                    {% if form.errors %}
                    <div class="alert alert-danger mb-2" style="font-size: 0.8rem; padding: 0.5rem;">
                        <i class="bi bi-exclamation-triangle"></i> –ü–æ–º–∏–ª–∫–∏ —Ñ–æ—Ä–º–∏:
                        <ul class="mb-0" style="font-size: 0.75rem;">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>{{ field }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <form method="post" action="{% url 'update_tracking' route.pk %}">
                        {% csrf_token %}
                        
                        <div class="mb-2">
                            <label for="id_progress_percent" class="form-label d-flex justify-content-between align-items-center mb-1" style="font-size: 0.85rem;">
                                <span><i class="bi bi-speedometer2"></i> –ü—Ä–æ–≥—Ä–µ—Å</span>
                                <span id="progress-value" class="badge bg-primary" style="font-size: 0.8rem;">{{ tracking.progress_percent }}%</span>
                            </label>
                            <input type="range" 
                                   class="form-range" 
                                   id="id_progress_percent" 
                                   name="progress_percent" 
                                   min="0" 
                                   max="100" 
                                   value="{{ tracking.progress_percent }}"
                                   style="height: 6px;"
                                   required
                                   oninput="document.getElementById('progress-value').textContent = this.value + '%';">
                        </div>
                        
                        <div class="mb-2">
                            <label for="id_current_location" class="form-label mb-1" style="font-size: 0.85rem;">
                                <i class="bi bi-pin-map"></i> –õ–æ–∫–∞—Ü—ñ—è
                            </label>
                            <input type="text" 
                                   class="form-control form-control-sm" 
                                   id="id_current_location" 
                                   name="current_location" 
                                   value="{{ tracking.current_location|default:'' }}"
                                   placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ—Ç–æ—á–Ω—É –ª–æ–∫–∞—Ü—ñ—é"
                                   required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100 btn-sm">
                            <i class="bi bi-check-circle"></i> –ó–±–µ—Ä–µ–≥—Ç–∏
                        </button>
                        <small class="text-muted d-block text-center mt-1" style="font-size: 0.7rem;">
                            <i class="bi bi-info-circle"></i> –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
                        </small>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if route_data %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mapElement = document.getElementById('trackingMap');
        if (!mapElement) return;
        
        function getFloat(value, defaultVal) {
            if (value === null || value === undefined || value === '' || value === 'null') {
                return defaultVal;
            }
            const num = parseFloat(String(value).replace(',', '.'));
            return isNaN(num) ? defaultVal : num;
        }
        
        const originLat = getFloat({{ route_data.origin.lat|default:"null" }}, 50.45);
        const originLng = getFloat({{ route_data.origin.lng|default:"null" }}, 30.52);
        const destLat = getFloat({{ route_data.destination.lat|default:"null" }}, 49.84);
        const destLng = getFloat({{ route_data.destination.lng|default:"null" }}, 24.03);
        const progressPercent = {{ tracking.progress_percent|default:0 }};
        
        const progress = Math.max(0, Math.min(100, progressPercent)) / 100.0;
        const currentLat = originLat + (destLat - originLat) * progress;
        const currentLng = originLng + (destLng - originLng) * progress;
        
        if (typeof L === 'undefined') {
            mapElement.innerHTML = '<div class="alert alert-warning m-4">–ö–∞—Ä—Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...</div>';
            return;
        }
        
        try {
            const map = L.map('trackingMap').setView([currentLat, currentLng], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            const origin = [originLat, originLng];
            const destination = [destLat, destLng];
            const current = [currentLat, currentLng];
            
            // –ú–∞—Ä–∫–µ—Ä –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
            const originIcon = L.divIcon({
                className: 'route-origin-marker',
                html: '<div style="background: #10b981; width: 35px; height: 35px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px rgba(16, 185, 129, 0.8); display: flex; align-items: center; justify-content: center; font-size: 18px;"><i class="bi bi-play-fill" style="color: white; margin-left: 2px;"></i></div>',
                iconSize: [35, 35],
                iconAnchor: [17, 17]
            });
            
            L.marker(origin, { icon: originIcon })
                .addTo(map)
                .bindPopup(`<strong>üìç –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è</strong><br>{{ route.origin_city|escapejs }}`);
            
            // –ú–∞—Ä–∫–µ—Ä –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
            const destinationIcon = L.divIcon({
                className: 'route-destination-marker',
                html: '<div style="background: #ef4444; width: 35px; height: 35px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px rgba(239, 68, 68, 0.8); display: flex; align-items: center; justify-content: center; font-size: 18px;"><i class="bi bi-flag-fill" style="color: white;"></i></div>',
                iconSize: [35, 35],
                iconAnchor: [17, 17]
            });
            
            L.marker(destination, { icon: destinationIcon })
                .addTo(map)
                .bindPopup(`<strong>üìç –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</strong><br>{{ route.destination_city|escapejs }}`);
            
            // –ú–∞—Ä–∫–µ—Ä –≤–∞–Ω—Ç–∞–∂—É
            const cargoIcon = L.divIcon({
                className: 'cargo-marker',
                html: '<div style="background: #3b82f6; width: 45px; height: 45px; border-radius: 50%; border: 4px solid white; box-shadow: 0 0 20px rgba(59, 130, 246, 1); display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;"><i class="bi bi-truck" style="color: white; font-size: 20px;"></i></div>',
                iconSize: [45, 45],
                iconAnchor: [22, 22]
            });
            
            const cargoMarker = L.marker(current, { icon: cargoIcon })
                .addTo(map)
                .bindPopup(`<strong>üöö –ü–æ—Ç–æ—á–Ω–∞ –ø–æ–∑–∏—Ü—ñ—è</strong><br>{{ tracking.current_location|escapejs }}<br><small>–ü—Ä–æ–≥—Ä–µ—Å: ${progressPercent}%</small>`)
                .openPopup();
            
            // –õ—ñ–Ω—ñ—ó –º–∞—Ä—à—Ä—É—Ç—É
            const completedRoute = L.polyline([origin, current], {
                color: '#10b981',
                weight: 5,
                opacity: 0.8
            }).addTo(map);
            
            const remainingRoute = L.polyline([current, destination], {
                color: '#ef4444',
                weight: 5,
                opacity: 0.5,
                dashArray: '10, 5'
            }).addTo(map);
            
            map.fitBounds([origin, destination, current], { padding: [50, 50] });
            
        } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Ä—Ç–∏:', error);
            mapElement.innerHTML = '<div class="alert alert-danger m-4">–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏</div>';
        }
    });
</script>
{% endif %}
{% endblock %}
