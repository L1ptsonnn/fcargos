{% extends 'base.html' %}

{% block title %}Профіль {{ profile_user.username }} - FCargos{% endblock %}

{% block extra_css %}
<style>
    .profile-header {
        background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
        background-size: 200% 200%;
        animation: gradientShift 5s ease infinite;
        padding: 3rem 0;
        margin: -2rem -15px 3rem -15px;
        border-radius: 0 0 30px 30px;
        color: white;
        box-shadow: var(--shadow-lg);
    }
    .profile-avatar {
        width: 120px;
        height: 120px;
        background: linear-gradient(135deg, var(--accent-gradient-start), var(--accent-gradient-end));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: white;
        margin: 0 auto;
        border: 5px solid white;
        box-shadow: var(--shadow-lg);
    }
    .stat-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1.5rem;
        transition: all 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-header">
    <div class="container text-center">
        <div class="profile-avatar mb-3">
            <i class="bi bi-{% if profile_user.role == 'company' %}building{% else %}truck{% endif %}"></i>
        </div>
        <h2 class="mb-1">{{ profile_user.username }}</h2>
        <p class="mb-0 opacity-75">{{ profile_user.get_role_display }}</p>
        {% if carrier_profile and carrier_profile.rating > 0 %}
        <div class="mt-3">
            <div class="rating-display">
                <span class="rating-stars" style="font-size: 1.5rem;">
                    {% with rating_rounded=carrier_profile.rating|floatformat:0 %}
                        {% for i in "12345" %}
                            {% if forloop.counter <= rating_rounded|add:0 %}
                                <i class="bi bi-star-fill text-warning"></i>
                            {% else %}
                                <i class="bi bi-star text-warning"></i>
                            {% endif %}
                        {% endfor %}
                    {% endwith %}
                </span>
                <span class="ms-2 fw-bold" style="font-size: 1.2rem;">{{ carrier_profile.rating }}/5.00</span>
                {% if ratings %}
                <small class="ms-2 opacity-75">({{ ratings|length }} оцінок)</small>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% if profile_user.phone %}
        <div class="mt-3">
            <a href="tel:{{ profile_user.phone }}" class="btn btn-light btn-sm">
                <i class="bi bi-telephone"></i> {{ profile_user.phone }}
            </a>
        </div>
        {% endif %}
    </div>
</div>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow-lg border-0 stat-card text-center">
                <div class="card-body">
                    <i class="bi bi-map" style="font-size: 2.5rem; color: var(--primary-gradient-start);"></i>
                    <h3 class="mt-3 mb-0">{{ routes_created }}</h3>
                    <p class="text-muted mb-0">{% if profile_user.role == 'company' %}Створено маршрутів{% else %}Виконано маршрутів{% endif %}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-lg border-0 stat-card text-center">
                <div class="card-body">
                    <i class="bi bi-truck" style="font-size: 2.5rem; color: var(--info-gradient-start);"></i>
                    <h3 class="mt-3 mb-0">{{ routes_in_transit }}</h3>
                    <p class="text-muted mb-0">В дорозі</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-lg border-0 stat-card text-center">
                <div class="card-body">
                    <i class="bi bi-check-circle" style="font-size: 2.5rem; color: var(--success-gradient-start);"></i>
                    <h3 class="mt-3 mb-0">{{ routes_completed }}</h3>
                    <p class="text-muted mb-0">Завершено</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-lg border-0">
        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-gradient-start), var(--accent-gradient-end)); color: white;">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Інформація профілю</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <strong><i class="bi bi-person"></i> Ім'я користувача:</strong><br>
                    {{ profile_user.username }}
                </div>
                <div class="col-md-6 mb-3">
                    <strong><i class="bi bi-shield-check"></i> Роль:</strong><br>
                    {{ profile_user.get_role_display }}
                </div>
                {% if profile_user.phone %}
                <div class="col-md-6 mb-3">
                    <strong><i class="bi bi-telephone"></i> Телефон:</strong><br>
                    <a href="tel:{{ profile_user.phone }}">{{ profile_user.phone }}</a>
                </div>
                {% endif %}
                {% if profile_user.company_name %}
                <div class="col-md-6 mb-3">
                    <strong><i class="bi bi-building"></i> Назва компанії:</strong><br>
                    {{ profile_user.company_name }}
                </div>
                {% endif %}
                <div class="col-md-6 mb-3">
                    <strong><i class="bi bi-calendar"></i> Дата реєстрації:</strong><br>
                    {{ profile_user.created_at|date:"d.m.Y" }}
                </div>
            </div>
        </div>
    </div>

    {% if profile_user.role == 'carrier' and rating_form %}
    <!-- Форма оцінки перевізника -->
    <div class="card shadow-lg border-0 mt-4">
        <div class="card-header" style="background: linear-gradient(135deg, var(--warning-gradient-start), var(--warning-gradient-end)); color: white;">
            <h5 class="mb-0"><i class="bi bi-star"></i> Оцінити перевізника</h5>
        </div>
        <div class="card-body">
            {% load crispy_forms_tags %}
            <form method="post">
                {% csrf_token %}
                {{ rating_form|crispy }}
                <button type="submit" name="rating_submit" class="btn btn-primary w-100 mt-3">
                    <i class="bi bi-star-fill"></i> {% if user_rating %}Оновити оцінку{% else %}Залишити оцінку{% endif %}
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    {% if profile_user.role == 'carrier' and ratings %}
    <!-- Останні оцінки -->
    <div class="card shadow-lg border-0 mt-4">
        <div class="card-header" style="background: linear-gradient(135deg, var(--success-gradient-start), var(--success-gradient-end)); color: white;">
            <h5 class="mb-0"><i class="bi bi-star"></i> Останні оцінки</h5>
        </div>
        <div class="card-body">
            {% for rating in ratings %}
            <div class="rating-item mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <strong>{{ rating.company.username }}</strong>
                        {% if rating.company.company_name %}
                        <span class="text-muted">({{ rating.company.company_name }})</span>
                        {% endif %}
                    </div>
                    <div class="rating-stars">
                        {% for i in "12345" %}
                            {% if forloop.counter <= rating.rating %}
                                <i class="bi bi-star-fill text-warning"></i>
                            {% else %}
                                <i class="bi bi-star text-muted"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% if rating.comment %}
                <p class="mb-1 text-muted">{{ rating.comment }}</p>
                {% endif %}
                <small class="text-muted">
                    <i class="bi bi-calendar"></i> {{ rating.created_at|date:"d.m.Y H:i" }}
                    {% if rating.route %}
                    | <a href="{% url 'route_detail' rating.route.pk %}" class="text-decoration-none">Маршрут: {{ rating.route.origin_city }} → {{ rating.route.destination_city }}</a>
                    {% endif %}
                </small>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

