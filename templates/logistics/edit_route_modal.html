<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É -->
<div class="modal fade" id="editRouteModal" tabindex="-1" aria-labelledby="editRouteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-lg-down modal-xl modal-dialog-scrollable">
        <div class="modal-content route-modal-content">
            <div class="modal-header route-modal-header">
                <div class="d-flex align-items-center w-100">
                    <div class="route-icon-wrapper me-3">
                        <i class="bi bi-geo-alt-fill"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="modal-title mb-0" id="editRouteModalLabel">
                            <strong>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç</strong>
                        </h5>
                        <small class="text-white-50">–û–Ω–æ–≤—ñ—Ç—å —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—ñ —Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤–∞–Ω—Ç–∞–∂</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
                </div>
            </div>
            <div class="modal-body p-4">
                <form method="post" id="editRouteForm" 
                      hx-post="{% url 'edit_route' route.pk %}" 
                      hx-target="#editRouteModalContent"
                      hx-swap="innerHTML"
                      hx-indicator="#loadingIndicator">
                    {% csrf_token %}
                    
                    <!-- –ö–∞—Ä—Ç–∞ –¥–ª—è –≤–∏–±–æ—Ä—É –º–∞—Ä—à—Ä—É—Ç—É -->
                    <div class="map-container-wrapper mb-4">
                        <div class="map-instruction-card">
                            <div class="d-flex align-items-start">
                                <div class="instruction-icon me-3">
                                    <i class="bi bi-info-circle-fill"></i>
                                </div>
                                <div>
                                    <h6 class="mb-2"><strong>–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:</strong></h6>
                                    <ol class="mb-0">
                                        <li>–ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ –¥–ª—è –≤–∏–±–æ—Ä—É <strong>—Ç–æ—á–∫–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è</strong></li>
                                        <li>–ö–ª—ñ–∫–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É <strong>—Ç–æ—á–∫–∏ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</strong></li>
                                        <li>–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤–∞–Ω—Ç–∞–∂ –Ω–∏–∂—á–µ</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        <div id="editRouteMap" class="route-map"></div>
                    </div>
                    
                    <!-- –í–∏–±—Ä–∞–Ω—ñ —Ç–æ—á–∫–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—é—Ç—å—Å—è) -->
                    <div class="row mb-4 g-3">
                        <div class="col-md-6">
                            <div class="selected-point-card" id="originPoint">
                                <div class="point-header">
                                    <div class="point-icon origin-icon">
                                        <i class="bi bi-geo-alt-fill"></i>
                                    </div>
                                    <h6 class="mb-0"><strong>–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è</strong></h6>
                                </div>
                                <p class="mb-0 text-muted mt-2" id="originPointText">
                                    {% if route.origin_city %}{{ route.origin_city }}, {{ route.origin_country }}{% else %}–û–±–µ—Ä—ñ—Ç—å —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç—ñ{% endif %}
                                </p>
                            </div>
                            {{ form.origin_city.as_hidden }}
                            {{ form.origin_country.as_hidden }}
                            {{ form.origin_lat.as_hidden }}
                            {{ form.origin_lng.as_hidden }}
                        </div>
                        <div class="col-md-6">
                            <div class="selected-point-card" id="destinationPoint">
                                <div class="point-header">
                                    <div class="point-icon destination-icon">
                                        <i class="bi bi-geo-alt-fill"></i>
                                    </div>
                                    <h6 class="mb-0"><strong>–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</strong></h6>
                                </div>
                                <p class="mb-0 text-muted mt-2" id="destinationPointText">
                                    {% if route.destination_city %}{{ route.destination_city }}, {{ route.destination_country }}{% else %}–û–±–µ—Ä—ñ—Ç—å —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç—ñ{% endif %}
                                </p>
                            </div>
                            {{ form.destination_city.as_hidden }}
                            {{ form.destination_country.as_hidden }}
                            {{ form.destination_lat.as_hidden }}
                            {{ form.destination_lng.as_hidden }}
                        </div>
                    </div>
                    
                    <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤–∞–Ω—Ç–∞–∂ -->
                    <div class="cargo-info-section">
                        <div class="section-header mb-4">
                            <div class="section-icon">
                                <i class="bi bi-box-seam"></i>
                            </div>
                            <h5 class="mb-0"><strong>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤–∞–Ω—Ç–∞–∂</strong></h5>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-tag"></i> –¢–∏–ø –≤–∞–Ω—Ç–∞–∂—É <span class="text-danger">*</span>
                                </label>
                                {{ form.cargo_type }}
                                <small class="text-muted d-block mt-1">–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ü–∞–∫—É–≤–∞–Ω–Ω—è, –ú–µ–±–ª—ñ</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-speedometer2"></i> –í–∞–≥–∞ (–∫–≥) <span class="text-danger">*</span>
                                </label>
                                {{ form.weight }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-box"></i> –û–±'—î–º (–º¬≥) <span class="text-danger">*</span>
                                </label>
                                {{ form.volume }}
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-currency-exchange"></i> –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —Ü—ñ–Ω–∞ (–≥—Ä–Ω) <span class="text-danger">*</span>
                                </label>
                                {{ form.price }}
                                <small class="text-muted d-block mt-1">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —Å—É–º–∞, —è–∫—É –≤–∏ –≥–æ—Ç–æ–≤—ñ –∑–∞–ø–ª–∞—Ç–∏—Ç–∏</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-calendar-event"></i> –î–∞—Ç–∞ –∑–∞–±–æ—Ä—É <span class="text-danger">*</span>
                                </label>
                                {{ form.pickup_date }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-calendar-check"></i> –î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ <span class="text-danger">*</span>
                                </label>
                                {{ form.delivery_date }}
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-file-text"></i> –û–ø–∏—Å –≤–∞–Ω—Ç–∞–∂—É (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)
                            </label>
                            {{ form.description }}
                        </div>
                    </div>
                    
                    <div class="alert alert-info alert-modern mt-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-lightbulb-fill me-3 fs-4"></i>
                            <div>
                                <strong>–ü—ñ–¥–∫–∞–∑–∫–∞:</strong> –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Ç–∞ –∞–¥—Ä–µ—Å–∏ –∑–∞–ø–æ–≤–Ω—é—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ —Ç–æ—á–æ–∫ –Ω–∞ –∫–∞—Ä—Ç—ñ!
                            </div>
                        </div>
                    </div>
                    
                    <div id="loadingIndicator" class="htmx-indicator text-center my-4">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É...</span>
                        </div>
                        <p class="mt-2 text-muted">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É...</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer route-modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-lg" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
                <button type="submit" form="editRouteForm" class="btn btn-success btn-lg" id="editSubmitBtn">
                    <i class="bi bi-check-circle"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* –°—Ç–∏–ª—ñ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ */
    .route-modal-content {
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .route-modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 1.5rem 2rem;
    }
    
    .route-icon-wrapper {
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }
    
    .route-modal-footer {
        border-top: 1px solid #e9ecef;
        padding: 1.5rem 2rem;
        background: #f8f9fa;
    }
    
    /* –°—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–∏ */
    .map-container-wrapper {
        position: relative;
        height: 500px;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        background: #f0f0f0;
    }
    
    .route-map {
        height: 100%;
        width: 100%;
        border-radius: 20px;
    }
    
    .map-instruction-card {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        max-width: 320px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.8);
    }
    
    .instruction-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        flex-shrink: 0;
    }
    
    .map-instruction-card ol {
        margin: 0;
        padding-left: 20px;
        font-size: 0.95rem;
        line-height: 1.8;
    }
    
    .map-instruction-card h6 {
        color: #667eea;
        font-weight: 600;
    }
    
    /* –°—Ç–∏–ª—ñ –¥–ª—è –≤–∏–±—Ä–∞–Ω–∏—Ö —Ç–æ—á–æ–∫ */
    .selected-point-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        padding: 20px;
        border-radius: 15px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .selected-point-card.success {
        border-color: #28a745;
        background: linear-gradient(135deg, #d4edda 0%, #f0f8f4 100%);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.2);
        transform: translateY(-2px);
    }
    
    .point-header {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .point-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
    }
    
    .origin-icon {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .destination-icon {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    }
    
    /* –°—Ç–∏–ª—ñ –¥–ª—è —Å–µ–∫—Ü—ñ—ó –≤–∞–Ω—Ç–∞–∂—É */
    .cargo-info-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        padding: 25px;
        border-radius: 15px;
        border: 1px solid #e9ecef;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .section-icon {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 22px;
    }
    
    .section-header h5 {
        color: #333;
    }
    
    /* –°—Ç–∏–ª—ñ –¥–ª—è —Ñ–æ—Ä–º–∏ */
    .form-control, .form-select {
        border-radius: 10px;
        border: 1px solid #dee2e6;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .form-label {
        color: #495057;
        margin-bottom: 8px;
    }
    
    /* –°—Ç–∏–ª—ñ –¥–ª—è alert */
    .alert-modern {
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, #e7f3ff 0%, #d1ecf1 100%);
        border-left: 4px solid #0dcaf0;
    }
    
    /* –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
    .htmx-indicator {
        display: none;
    }
    
    .htmx-request .htmx-indicator {
        display: block;
    }
    
    /* –ê–Ω—ñ–º–∞—Ü—ñ—ó */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .selected-point-card {
        animation: fadeIn 0.3s ease;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
    @media (max-width: 768px) {
        .map-container-wrapper {
            height: 350px;
        }
        
        .map-instruction-card {
            max-width: 100%;
            left: 10px;
            right: 10px;
            top: 10px;
        }
        
        .route-modal-header {
            padding: 1rem;
        }
        
        .route-icon-wrapper {
            width: 40px;
            height: 40px;
            font-size: 20px;
        }
    }
</style>

<script>
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ window –æ–±'—î–∫—Ç –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
    if (!window.routeModalData) {
        window.routeModalData = {
            routeMap: null,
            originMarker: null,
            destMarker: null,
            routeLine: null,
            originSelected: false,
            destSelected: false,
            initialized: false
        };
    }
    
    // –§—É–Ω–∫—Ü—ñ—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Ä—Ç–∏
    function initMap() {
        const mapElement = document.getElementById('routeMap');
        if (!mapElement) {
            console.error('–ï–ª–µ–º–µ–Ω—Ç –∫–∞—Ä—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
            return;
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ Leaflet –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π
        if (typeof L === 'undefined') {
            console.error('Leaflet –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π!');
            mapElement.innerHTML = '<div class="alert alert-danger m-3">–ü–æ–º–∏–ª–∫–∞: –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –∫–∞—Ä—Ç –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∞—Å—å. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É.</div>';
            return;
        }
        
        try {
            // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—É –∫–∞—Ä—Ç—É, —è–∫—â–æ –≤–æ–Ω–∞ —ñ—Å–Ω—É—î
            if (window.routeModalData.routeMap) {
                try {
                    window.routeModalData.routeMap.remove();
                } catch (e) {
                    console.log('–ö–∞—Ä—Ç–∞ –≤–∂–µ –≤–∏–¥–∞–ª–µ–Ω–∞');
                }
                window.routeModalData.routeMap = null;
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–∞—î —Ä–æ–∑–º—ñ—Ä–∏
            if (mapElement.offsetWidth === 0 || mapElement.offsetHeight === 0) {
                console.warn('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç–∏ –Ω–µ –º–∞—î —Ä–æ–∑–º—ñ—Ä—ñ–≤, —á–µ–∫–∞—î–º–æ...');
                setTimeout(initMap, 200);
                return;
            }
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É –∫–∞—Ä—Ç—É
            window.routeModalData.routeMap = L.map('editRouteMap', {
                zoomControl: true,
                scrollWheelZoom: true
            }).setView([50.45, 30.52], 6);
            
            // –î–æ–¥–∞—î–º–æ —Ç–∞–π–ª–∏
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(window.routeModalData.routeMap);
            
            // –í–∏–ø—Ä–∞–≤–ª—è—î–º–æ —Ä–æ–∑–º—ñ—Ä–∏ –∫–∞—Ä—Ç–∏ –ø—ñ—Å–ª—è –Ω–µ–≤–µ–ª–∏–∫–æ—ó –∑–∞—Ç—Ä–∏–º–∫–∏
            setTimeout(function() {
                if (window.routeModalData.routeMap) {
                    window.routeModalData.routeMap.invalidateSize();
                }
            }, 100);
            
            // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—ñ–≤
            setupMapClickHandler();
            
        } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Ä—Ç–∏:', error);
            mapElement.innerHTML = '<div class="alert alert-danger m-3">–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É.</div>';
        }
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫–∞ –∫–ª—ñ–∫—ñ–≤ –Ω–∞ –∫–∞—Ä—Ç—ñ
    function setupMapClickHandler() {
        if (!window.routeModalData.routeMap) return;
        
        window.routeModalData.routeMap.off('click'); // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏
        
        window.routeModalData.routeMap.on('click', function(e) {
            if (!e || !e.latlng) {
                console.error('–ü–æ–º–∏–ª–∫–∞: –Ω–µ–≤–∞–ª—ñ–¥–Ω—ñ –¥–∞–Ω—ñ –∫–ª—ñ–∫—É');
                return;
            }
            
            const lat = parseFloat(e.latlng.lat);
            const lng = parseFloat(e.latlng.lng);
            
            // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                console.error('–ü–æ–º–∏–ª–∫–∞: –Ω–µ–≤–∞–ª—ñ–¥–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏');
                return;
            }
        
            // –û—Ç—Ä–∏–º—É—î–º–æ –∞–¥—Ä–µ—Å—É —á–µ—Ä–µ–∑ –≥–µ–æ–∫–æ–¥—É–≤–∞–Ω–Ω—è
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=uk`)
                .then(response => response.json())
                .then(data => {
                    const address = data.address || {};
                    const city = address.city || address.town || address.village || address.municipality || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
                    const country = address.country || '–£–∫—Ä–∞—ó–Ω–∞';
                    
                    if (!window.routeModalData.originSelected) {
                        // –í–∏–±—ñ—Ä —Ç–æ—á–∫–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
                        if (window.routeModalData.originMarker) window.routeModalData.routeMap.removeLayer(window.routeModalData.originMarker);
                        
                        window.routeModalData.originMarker = L.marker([lat, lng], {
                            draggable: true,
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: '<div style="background: #28a745; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px rgba(40, 167, 69, 0.8); display: flex; align-items: center; justify-content: center;"><i class="bi bi-geo-alt-fill" style="color: white; font-size: 16px;"></i></div>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            })
                        }).addTo(window.routeModalData.routeMap)
                            .bindPopup(`<b>üìç –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è</b><br>${city}, ${country}`).openPopup();
                        
                        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø—Ä–∞–≤–æ—ó –∫–Ω–æ–ø–∫–∏ –º–∏—à—ñ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞
                        window.routeModalData.originMarker.on('contextmenu', function(e) {
                            e.originalEvent.preventDefault();
                            removeOriginPoint();
                        });
                        
                        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ñ–æ—Ä–º—É
                        document.getElementById('id_origin_lat').value = lat.toFixed(6);
                        document.getElementById('id_origin_lng').value = lng.toFixed(6);
                        document.getElementById('id_origin_city').value = city;
                        document.getElementById('id_origin_country').value = country;
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                        updateOriginPoint(city, country);
                        window.routeModalData.originSelected = true;
                    } else if (!window.routeModalData.destSelected) {
                        // –í–∏–±—ñ—Ä —Ç–æ—á–∫–∏ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
                        if (window.routeModalData.destMarker) window.routeModalData.routeMap.removeLayer(window.routeModalData.destMarker);
                        
                        window.routeModalData.destMarker = L.marker([lat, lng], {
                            draggable: true,
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: '<div style="background: #dc3545; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px rgba(220, 53, 69, 0.8); display: flex; align-items: center; justify-content: center;"><i class="bi bi-geo-alt-fill" style="color: white; font-size: 16px;"></i></div>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            })
                        }).addTo(window.routeModalData.routeMap)
                            .bindPopup(`<b>üìç –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</b><br>${city}, ${country}`).openPopup();
                        
                        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø—Ä–∞–≤–æ—ó –∫–Ω–æ–ø–∫–∏ –º–∏—à—ñ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞
                        window.routeModalData.destMarker.on('contextmenu', function(e) {
                            e.originalEvent.preventDefault();
                            removeDestinationPoint();
                        });
                        
                        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ñ–æ—Ä–º—É
                        document.getElementById('id_destination_lat').value = lat.toFixed(6);
                        document.getElementById('id_destination_lng').value = lng.toFixed(6);
                        document.getElementById('id_destination_city').value = city;
                        document.getElementById('id_destination_country').value = country;
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                        updateDestinationPoint(city, country);
                        window.routeModalData.destSelected = true;
                        
                        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤
                        window.routeModalData.originMarker.on('dragend', function(e) {
                            const pos = e.target.getLatLng();
                            updateCoordinates('origin', pos.lat, pos.lng);
                        });
                        
                        window.routeModalData.destMarker.on('dragend', function(e) {
                            const pos = e.target.getLatLng();
                            updateCoordinates('destination', pos.lat, pos.lng);
                        });
                        
                        // –ú–∞–ª—é—î–º–æ –ª—ñ–Ω—ñ—é –º–∞—Ä—à—Ä—É—Ç—É
                        updateRouteLine();
                        
                        // –ê–∫—Ç–∏–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
                        const submitBtn = document.getElementById('submitBtn');
                        if (submitBtn) submitBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –≥–µ–æ–∫–æ–¥—É–≤–∞–Ω–Ω—è:', error);
                });
        });
    }
    
    // –§—É–Ω–∫—Ü—ñ—ó –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–æ—á–æ–∫
    function updateOriginPoint(city, country) {
        const element = document.getElementById('originPoint');
        element.innerHTML = `
            <div class="point-header">
                <div class="point-icon origin-icon">
                    <i class="bi bi-geo-alt-fill"></i>
                </div>
                <h6 class="mb-0"><strong>–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è</strong></h6>
            </div>
            <p class="mb-0 mt-2"><strong>${city}, ${country}</strong></p>
        `;
        element.classList.add('success');
    }
    
    function updateDestinationPoint(city, country) {
        const element = document.getElementById('destinationPoint');
        element.innerHTML = `
            <div class="point-header">
                <div class="point-icon destination-icon">
                    <i class="bi bi-geo-alt-fill"></i>
                </div>
                <h6 class="mb-0"><strong>–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</strong></h6>
            </div>
            <p class="mb-0 mt-2"><strong>${city}, ${country}</strong></p>
        `;
        element.classList.add('success');
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–æ—á–∫–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è (–ø—Ä–∞–≤–∞ –∫–Ω–æ–ø–∫–∞ –º–∏—à—ñ)
    function removeOriginPoint() {
        if (window.routeModalData.originMarker && window.routeModalData.routeMap) {
            window.routeModalData.routeMap.removeLayer(window.routeModalData.originMarker);
            window.routeModalData.originMarker = null;
        }
        window.routeModalData.originSelected = false;
        
        // –û—á–∏—â–∞—î–º–æ –ø–æ–ª—è —Ñ–æ—Ä–º–∏
        document.getElementById('id_origin_lat').value = '';
        document.getElementById('id_origin_lng').value = '';
        document.getElementById('id_origin_city').value = '';
        document.getElementById('id_origin_country').value = '';
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        const element = document.getElementById('originPoint');
        const originPointText = document.getElementById('originPointText');
        if (originPointText) {
            originPointText.textContent = '–û–±–µ—Ä—ñ—Ç—å —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç—ñ';
            originPointText.className = 'mb-0 text-muted mt-2';
        }
        if (element) {
            element.classList.remove('success');
        }
        
        // –í–∏–¥–∞–ª—è—î–º–æ –ª—ñ–Ω—ñ—é –º–∞—Ä—à—Ä—É—Ç—É, —è–∫—â–æ –≤–æ–Ω–∞ —î
        if (window.routeModalData.routeLine && window.routeModalData.routeMap) {
            window.routeModalData.routeMap.removeLayer(window.routeModalData.routeLine);
            window.routeModalData.routeLine = null;
        }
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–æ—á–∫–∏ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è (–ø—Ä–∞–≤–∞ –∫–Ω–æ–ø–∫–∞ –º–∏—à—ñ)
    function removeDestinationPoint() {
        if (window.routeModalData.destMarker && window.routeModalData.routeMap) {
            window.routeModalData.routeMap.removeLayer(window.routeModalData.destMarker);
            window.routeModalData.destMarker = null;
        }
        window.routeModalData.destSelected = false;
        
        // –û—á–∏—â–∞—î–º–æ –ø–æ–ª—è —Ñ–æ—Ä–º–∏
        document.getElementById('id_destination_lat').value = '';
        document.getElementById('id_destination_lng').value = '';
        document.getElementById('id_destination_city').value = '';
        document.getElementById('id_destination_country').value = '';
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        const element = document.getElementById('destinationPoint');
        const destinationPointText = document.getElementById('destinationPointText');
        if (destinationPointText) {
            destinationPointText.textContent = '–û–±–µ—Ä—ñ—Ç—å —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç—ñ';
            destinationPointText.className = 'mb-0 text-muted mt-2';
        }
        if (element) {
            element.classList.remove('success');
        }
        
        // –í–∏–¥–∞–ª—è—î–º–æ –ª—ñ–Ω—ñ—é –º–∞—Ä—à—Ä—É—Ç—É, —è–∫—â–æ –≤–æ–Ω–∞ —î
        if (window.routeModalData.routeLine && window.routeModalData.routeMap) {
            window.routeModalData.routeMap.removeLayer(window.routeModalData.routeLine);
            window.routeModalData.routeLine = null;
        }
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø—Ä–∏ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—ñ
    function updateCoordinates(type, lat, lng) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=uk`)
            .then(response => response.json())
            .then(data => {
                const address = data.address || {};
                const city = address.city || address.town || address.village || address.municipality || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
                const country = address.country || '–£–∫—Ä–∞—ó–Ω–∞';
                
                if (type === 'origin') {
                    document.getElementById('id_origin_lat').value = lat.toFixed(6);
                    document.getElementById('id_origin_lng').value = lng.toFixed(6);
                    document.getElementById('id_origin_city').value = city;
                    document.getElementById('id_origin_country').value = country;
                    updateOriginPoint(city, country);
                } else {
                    document.getElementById('id_destination_lat').value = lat.toFixed(6);
                    document.getElementById('id_destination_lng').value = lng.toFixed(6);
                    document.getElementById('id_destination_city').value = city;
                    document.getElementById('id_destination_country').value = country;
                    updateDestinationPoint(city, country);
                }
                updateRouteLine();
            })
            .catch(error => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –≥–µ–æ–∫–æ–¥—É–≤–∞–Ω–Ω—è:', error);
            });
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ–Ω—ñ—ó –º–∞—Ä—à—Ä—É—Ç—É
    function updateRouteLine() {
        if (!window.routeModalData.routeMap) return;
        
        try {
            if (window.routeModalData.routeLine) window.routeModalData.routeMap.removeLayer(window.routeModalData.routeLine);
            if (window.routeModalData.originMarker && window.routeModalData.destMarker) {
                const originPos = window.routeModalData.originMarker.getLatLng();
                const destPos = window.routeModalData.destMarker.getLatLng();
                
                if (originPos && destPos) {
                    window.routeModalData.routeLine = L.polyline([
                        [originPos.lat, originPos.lng],
                        [destPos.lat, destPos.lng]
                    ], {
                        color: '#667eea',
                        weight: 5,
                        opacity: 0.7,
                        dashArray: '15, 10'
                    }).addTo(window.routeModalData.routeMap);
                    
                    window.routeModalData.routeMap.fitBounds([originPos, destPos], {
                        padding: [80, 80]
                    });
                }
            }
        } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ–Ω—ñ—ó –º–∞—Ä—à—Ä—É—Ç—É:', error);
        }
    }
    
    // –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ–π –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    (function() {
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π –¥–ª—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É
        document.addEventListener('shown.bs.modal', function(event) {
            const modal = event.target;
            if (modal && modal.id === 'editRouteModal') {
                // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω
                window.routeModalData.originSelected = false;
                window.routeModalData.destSelected = false;
                if (window.routeModalData.originMarker && window.routeModalData.routeMap) {
                    window.routeModalData.routeMap.removeLayer(window.routeModalData.originMarker);
                }
                if (window.routeModalData.destMarker && window.routeModalData.routeMap) {
                    window.routeModalData.routeMap.removeLayer(window.routeModalData.destMarker);
                }
                if (window.routeModalData.routeLine && window.routeModalData.routeMap) {
                    window.routeModalData.routeMap.removeLayer(window.routeModalData.routeLine);
                }
                window.routeModalData.originMarker = null;
                window.routeModalData.destMarker = null;
                window.routeModalData.routeLine = null;
            
            // –°–∫–∏–¥–∞—î–º–æ —Ñ–æ—Ä–º—É
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) submitBtn.disabled = true;
            
            const originPoint = document.getElementById('originPoint');
            const destinationPoint = document.getElementById('destinationPoint');
            if (originPoint) {
                originPoint.innerHTML = `
                    <div class="point-header">
                        <div class="point-icon origin-icon">
                            <i class="bi bi-geo-alt-fill"></i>
                        </div>
                        <h6 class="mb-0"><strong>–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è</strong></h6>
                    </div>
                    <p class="mb-0 text-muted mt-2">–û–±–µ—Ä—ñ—Ç—å —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç—ñ</p>
                `;
                originPoint.classList.remove('success');
            }
            if (destinationPoint) {
                destinationPoint.innerHTML = `
                    <div class="point-header">
                        <div class="point-icon destination-icon">
                            <i class="bi bi-geo-alt-fill"></i>
                        </div>
                        <h6 class="mb-0"><strong>–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</strong></h6>
                    </div>
                    <p class="mb-0 text-muted mt-2">–û–±–µ—Ä—ñ—Ç—å —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç—ñ</p>
                `;
                destinationPoint.classList.remove('success');
            }
            
                // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∫–∞—Ä—Ç—É –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø–æ–≤–Ω—ñ—Å—Ç—é –≤—ñ–¥–∫—Ä–∏–ª–æ—Å—è
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –±—ñ–ª—å—à—É –∑–∞—Ç—Ä–∏–º–∫—É –¥–ª—è –≥–∞—Ä–∞–Ω—Ç—ñ—ó, —â–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –º–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏
                setTimeout(function() {
                    const mapElement = document.getElementById('editRouteMap');
                    const modalElement = document.getElementById('editRouteModal');
                    if (mapElement && modalElement && modalElement.classList.contains('show')) {
                        initEditMap();
                    }
                }, 500);
            }
        });
        
        // –ü—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        document.addEventListener('hidden.bs.modal', function(event) {
            const modal = event.target;
            if (modal && modal.id === 'editRouteModal') {
                // –û—á–∏—â–∞—î–º–æ –∫–∞—Ä—Ç—É
                if (window.routeModalData.routeMap) {
                    if (window.routeModalData.originMarker) {
                        window.routeModalData.routeMap.removeLayer(window.routeModalData.originMarker);
                    }
                    if (window.routeModalData.destMarker) {
                        window.routeModalData.routeMap.removeLayer(window.routeModalData.destMarker);
                    }
                    if (window.routeModalData.routeLine) {
                        window.routeModalData.routeMap.removeLayer(window.routeModalData.routeLine);
                    }
                    window.routeModalData.routeMap.remove();
                    window.routeModalData.routeMap = null;
                }
            }
        });
        
        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ñ–æ—Ä–º–∏ –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è)
        document.addEventListener('submit', function(e) {
            if (e.target && e.target.id === 'editRouteForm') {
                // –î–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –Ω–µ –≤–∏–º–∞–≥–∞—î–º–æ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ–≥–æ –≤–∏–±–æ—Ä—É —Ç–æ—á–æ–∫, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∏ –≤–∂–µ —î
            }
        });
    })();
    
    // –§—É–Ω–∫—Ü—ñ—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Ä—Ç–∏ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑ –ø–æ—á–∞—Ç–∫–æ–≤–∏–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
    function initEditMap() {
        const mapElement = document.getElementById('editRouteMap');
        if (!mapElement) {
            console.error('–ï–ª–µ–º–µ–Ω—Ç –∫–∞—Ä—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
            return;
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ Leaflet –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π
        if (typeof L === 'undefined') {
            console.error('Leaflet –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π!');
            mapElement.innerHTML = '<div class="alert alert-danger m-3">–ü–æ–º–∏–ª–∫–∞: –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –∫–∞—Ä—Ç –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∞—Å—å. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É.</div>';
            return;
        }
        
        try {
            // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—É –∫–∞—Ä—Ç—É, —è–∫—â–æ –≤–æ–Ω–∞ —ñ—Å–Ω—É—î
            if (window.routeModalData.routeMap) {
                try {
                    window.routeModalData.routeMap.remove();
                } catch (e) {
                    console.log('–ö–∞—Ä—Ç–∞ –≤–∂–µ –≤–∏–¥–∞–ª–µ–Ω–∞');
                }
                window.routeModalData.routeMap = null;
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–∞—î —Ä–æ–∑–º—ñ—Ä–∏
            if (mapElement.offsetWidth === 0 || mapElement.offsetHeight === 0) {
                console.warn('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç–∏ –Ω–µ –º–∞—î —Ä–æ–∑–º—ñ—Ä—ñ–≤, —á–µ–∫–∞—î–º–æ...');
                setTimeout(initEditMap, 200);
                return;
            }
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∑ —Ñ–æ—Ä–º–∏
            const originLat = parseFloat(document.getElementById('id_origin_lat').value) || 50.45;
            const originLng = parseFloat(document.getElementById('id_origin_lng').value) || 30.52;
            const destLat = parseFloat(document.getElementById('id_destination_lat').value) || 49.84;
            const destLng = parseFloat(document.getElementById('id_destination_lng').value) || 24.03;
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É –∫–∞—Ä—Ç—É –∑ —Ü–µ–Ω—Ç—Ä–æ–º –º—ñ–∂ —Ç–æ—á–∫–∞–º–∏
            const centerLat = (originLat + destLat) / 2;
            const centerLng = (originLng + destLng) / 2;
            window.routeModalData.routeMap = L.map('editRouteMap', {
                zoomControl: true,
                scrollWheelZoom: true
            }).setView([centerLat, centerLng], 6);
            
            // –î–æ–¥–∞—î–º–æ —Ç–∞–π–ª–∏
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(window.routeModalData.routeMap);
            
            // –î–æ–¥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä–∏ –¥–ª—è —ñ—Å–Ω—É—é—á–∏—Ö —Ç–æ—á–æ–∫
            if (originLat && originLng) {
                window.routeModalData.originMarker = L.marker([originLat, originLng], {
                    draggable: true,
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background: #28a745; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px rgba(40, 167, 69, 0.8); display: flex; align-items: center; justify-content: center;"><i class="bi bi-geo-alt-fill" style="color: white; font-size: 16px;"></i></div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(window.routeModalData.routeMap);
                window.routeModalData.originSelected = true;
                
                // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø—Ä–∞–≤–æ—ó –∫–Ω–æ–ø–∫–∏ –º–∏—à—ñ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞
                window.routeModalData.originMarker.on('contextmenu', function(e) {
                    e.originalEvent.preventDefault();
                    removeOriginPoint();
                });
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                const originCity = document.getElementById('id_origin_city').value;
                const originCountry = document.getElementById('id_origin_country').value;
                if (originCity) {
                    updateOriginPoint(originCity, originCountry);
                }
            }
            
            if (destLat && destLng) {
                window.routeModalData.destMarker = L.marker([destLat, destLng], {
                    draggable: true,
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background: #dc3545; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px rgba(220, 53, 69, 0.8); display: flex; align-items: center; justify-content: center;"><i class="bi bi-geo-alt-fill" style="color: white; font-size: 16px;"></i></div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(window.routeModalData.routeMap);
                window.routeModalData.destSelected = true;
                
                // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø—Ä–∞–≤–æ—ó –∫–Ω–æ–ø–∫–∏ –º–∏—à—ñ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞
                window.routeModalData.destMarker.on('contextmenu', function(e) {
                    e.originalEvent.preventDefault();
                    removeDestinationPoint();
                });
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                const destCity = document.getElementById('id_destination_city').value;
                const destCountry = document.getElementById('id_destination_country').value;
                if (destCity) {
                    updateDestinationPoint(destCity, destCountry);
                }
            }
            
            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
            if (window.routeModalData.originMarker) {
                window.routeModalData.originMarker.on('dragend', function(e) {
                    const pos = e.target.getLatLng();
                    updateCoordinates('origin', pos.lat, pos.lng);
                });
            }
            
            if (window.routeModalData.destMarker) {
                window.routeModalData.destMarker.on('dragend', function(e) {
                    const pos = e.target.getLatLng();
                    updateCoordinates('destination', pos.lat, pos.lng);
                });
            }
            
            // –ú–∞–ª—é—î–º–æ –ª—ñ–Ω—ñ—é –º–∞—Ä—à—Ä—É—Ç—É, —è–∫—â–æ –æ–±–∏–¥–≤—ñ —Ç–æ—á–∫–∏ —î
            if (window.routeModalData.originMarker && window.routeModalData.destMarker) {
                updateRouteLine();
            }
            
            // –í–∏–ø—Ä–∞–≤–ª—è—î–º–æ —Ä–æ–∑–º—ñ—Ä–∏ –∫–∞—Ä—Ç–∏ –ø—ñ—Å–ª—è –Ω–µ–≤–µ–ª–∏–∫–æ—ó –∑–∞—Ç—Ä–∏–º–∫–∏
            setTimeout(function() {
                if (window.routeModalData.routeMap) {
                    window.routeModalData.routeMap.invalidateSize();
                    if (window.routeModalData.originMarker && window.routeModalData.destMarker) {
                        const originPos = window.routeModalData.originMarker.getLatLng();
                        const destPos = window.routeModalData.destMarker.getLatLng();
                        window.routeModalData.routeMap.fitBounds([originPos, destPos], {
                            padding: [80, 80]
                        });
                    }
                }
            }, 100);
            
            // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—ñ–≤
            setupMapClickHandler();
            
        } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Ä—Ç–∏:', error);
            mapElement.innerHTML = '<div class="alert alert-danger m-3">–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É.</div>';
        }
    }
    
    // –û–±—Ä–æ–±–∫–∞ —É—Å–ø—ñ—à–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ HTMX –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    if (!window.editRouteModalHtmxHandler) {
        window.editRouteModalHtmxHandler = true;
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'editRouteModalContent') {
                // –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DOM
                setTimeout(function() {
                    const modalElement = document.getElementById('editRouteModal');
                    if (modalElement) {
                        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement, {
                                backdrop: true,
                                keyboard: true,
                                focus: true
                            });
                        }
                        
                        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤–∂–µ –≤—ñ–¥–∫—Ä–∏—Ç–µ
                        if (!modalElement.classList.contains('show')) {
                            modal.show();
                        }
                    }
                }, 50);
                
                const response = event.detail.xhr.responseText;
                // –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è, –≤–∏–∫–æ–Ω—É—î–º–æ –π–æ–≥–æ
                if (response.includes('window.location.href')) {
                    const scriptMatch = response.match(/<script>(.*?)<\/script>/s);
                    if (scriptMatch) {
                        eval(scriptMatch[1]);
                    }
                }
            }
        });
    }
</script>
