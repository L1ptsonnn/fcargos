{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}–°—Ç–≤–æ—Ä–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç - FCargos{% endblock %}

{% block extra_css %}
<style>
    .map-selector {
        height: 400px;
        border-radius: 10px;
        margin-bottom: 20px;
        position: relative;
    }
    .search-box {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        width: 300px;
    }
    .city-search {
        margin-bottom: 10px;
    }
    .search-results {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 5px;
    }
    .search-result-item {
        padding: 8px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
    }
    .search-result-item:hover {
        background: #f0f0f0;
    }
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
    }
    .step {
        flex: 1;
        text-align: center;
        padding: 15px;
        background: #f0f0f0;
        border-radius: 10px;
        margin: 0 5px;
        position: relative;
    }
    .step.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .step.completed {
        background: #28a745;
        color: white;
    }
    .form-section {
        display: none;
    }
    .form-section.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="text-center py-3">
                        <i class="bi bi-plus-circle" style="font-size: 48px;"></i>
                        <h3 class="mt-2 mb-0">–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –º–∞—Ä—à—Ä—É—Ç</h3>
                    </div>
                </div>
                <div class="card-body p-5">
                    <!-- Step Indicator -->
                    <div class="step-indicator">
                        <div class="step active" id="step1-indicator">
                            <i class="bi bi-geo-alt"></i><br>
                            <strong>1. –ú–∞—Ä—à—Ä—É—Ç</strong>
                        </div>
                        <div class="step" id="step2-indicator">
                            <i class="bi bi-box"></i><br>
                            <strong>2. –í–∞–Ω—Ç–∞–∂</strong>
                        </div>
                        <div class="step" id="step3-indicator">
                            <i class="bi bi-calendar"></i><br>
                            <strong>3. –î–∞—Ç–∏</strong>
                        </div>
                        <div class="step" id="step4-indicator">
                            <i class="bi bi-check-circle"></i><br>
                            <strong>4. –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è</strong>
                        </div>
                    </div>
                    
                    <form method="post" id="routeForm">
                        {% csrf_token %}
                        
                        <!-- Step 1: Route -->
                        <div class="form-section active" id="step1">
                            <h4 class="mb-4"><i class="bi bi-geo-alt"></i> –í–∏–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç</h4>
                            
                            <!-- Search Box -->
                            <div class="map-selector">
                                <div class="search-box">
                                    <div class="city-search">
                                        <label class="form-label"><strong>–ü–æ—à—É–∫ –º—ñ—Å—Ç–∞:</strong></label>
                                        <input type="text" id="citySearch" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞...">
                                        <div class="search-results" id="searchResults" style="display: none;"></div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-sm btn-primary w-100" onclick="setSearchType('origin')">
                                            <i class="bi bi-geo-alt"></i> –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
                                        </button>
                                        <button type="button" class="btn btn-sm btn-success w-100" onclick="setSearchType('destination')">
                                            <i class="bi bi-geo-alt-fill"></i> –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
                                        </button>
                                    </div>
                                </div>
                                <div id="routeMap" style="height: 100%; width: 100%;"></div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <i class="bi bi-geo-alt"></i> –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">–ú—ñ—Å—Ç–æ *</label>
                                                {{ form.origin_city }}
                                                <small class="text-muted">–ê–±–æ –≤–∏–±–µ—Ä—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ</small>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">–ö—Ä–∞—ó–Ω–∞ *</label>
                                                {{ form.origin_country }}
                                            </div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <label class="form-label">–®–∏—Ä–æ—Ç–∞</label>
                                                    {{ form.origin_lat }}
                                                </div>
                                                <div class="col-6">
                                                    <label class="form-label">–î–æ–≤–≥–æ—Ç–∞</label>
                                                    {{ form.origin_lng }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white">
                                            <i class="bi bi-geo-alt-fill"></i> –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">–ú—ñ—Å—Ç–æ *</label>
                                                {{ form.destination_city }}
                                                <small class="text-muted">–ê–±–æ –≤–∏–±–µ—Ä—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ</small>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">–ö—Ä–∞—ó–Ω–∞ *</label>
                                                {{ form.destination_country }}
                                            </div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <label class="form-label">–®–∏—Ä–æ—Ç–∞</label>
                                                    {{ form.destination_lat }}
                                                </div>
                                                <div class="col-6">
                                                    <label class="form-label">–î–æ–≤–≥–æ—Ç–∞</label>
                                                    {{ form.destination_lng }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-primary btn-lg" onclick="nextStep()">
                                    –î–∞–ª—ñ <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 2: Cargo -->
                        <div class="form-section" id="step2">
                            <h4 class="mb-4"><i class="bi bi-box"></i> –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤–∞–Ω—Ç–∞–∂</h4>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">–¢–∏–ø –≤–∞–Ω—Ç–∞–∂—É *</label>
                                    {{ form.cargo_type }}
                                    <small class="text-muted">–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ü–∞–∫—É–≤–∞–Ω–Ω—è, –ú–µ–±–ª—ñ, –ü—Ä–æ–¥—É–∫—Ç–∏</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">–¶—ñ–Ω–∞ (–≥—Ä–Ω) *</label>
                                    {{ form.price }}
                                    <small class="text-muted">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —Ü—ñ–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫—ñ–≤</small>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">–í–∞–≥–∞ (–∫–≥) *</label>
                                    {{ form.weight }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">–û–±'—î–º (–º¬≥) *</label>
                                    {{ form.volume }}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">–û–ø–∏—Å –≤–∞–Ω—Ç–∞–∂—É</label>
                                {{ form.description }}
                                <small class="text-muted">–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤–∞–Ω—Ç–∞–∂</small>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="prevStep()">
                                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
                                </button>
                                <button type="button" class="btn btn-primary btn-lg" onclick="nextStep()">
                                    –î–∞–ª—ñ <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 3: Dates -->
                        <div class="form-section" id="step3">
                            <h4 class="mb-4"><i class="bi bi-calendar"></i> –î–∞—Ç–∏ –∑–∞–±–æ—Ä—É —Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</h4>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">–î–∞—Ç–∞ —Ç–∞ —á–∞—Å –∑–∞–±–æ—Ä—É *</label>
                                    {{ form.pickup_date }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">–î–∞—Ç–∞ —Ç–∞ —á–∞—Å –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
                                    {{ form.delivery_date }}
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>–ü—ñ–¥–∫–∞–∑–∫–∞:</strong> –í–∫–∞–∂—ñ—Ç—å —Ç–æ—á–Ω—ñ –¥–∞—Ç–∏ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="prevStep()">
                                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
                                </button>
                                <button type="button" class="btn btn-primary btn-lg" onclick="nextStep()">
                                    –î–∞–ª—ñ <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 4: Submit -->
                        <div class="form-section" id="step4">
                            <h4 class="mb-4"><i class="bi bi-check-circle"></i> –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è</h4>
                            
                            <div class="card border-success mb-4">
                                <div class="card-body">
                                    <h5>–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∞–Ω—ñ:</h5>
                                    <div id="reviewData"></div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="prevStep()">
                                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
                                </button>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-check-circle"></i> –°—Ç–≤–æ—Ä–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    let currentStep = 1;
    let searchType = 'origin';
    let originMarker = null;
    let destMarker = null;
    let routeLine = null;
    let searchTimeout = null;
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏
    const routeMap = L.map('routeMap').setView([50.45, 30.52], 6);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(routeMap);
    
    function setSearchType(type) {
        searchType = type;
        document.getElementById('citySearch').focus();
    }
    
    // –ü–æ—à—É–∫ –º—ñ—Å—Ç
    document.getElementById('citySearch').addEventListener('input', function(e) {
        const query = e.target.value;
        if (query.length < 3) {
            document.getElementById('searchResults').style.display = 'none';
            return;
        }
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                .then(response => response.json())
                .then(data => {
                    const resultsDiv = document.getElementById('searchResults');
                    if (data.length > 0) {
                        resultsDiv.innerHTML = '';
                        data.forEach(result => {
                            const item = document.createElement('div');
                            item.className = 'search-result-item';
                            item.innerHTML = `<strong>${result.display_name}</strong>`;
                            item.onclick = () => {
                                selectCity(result.lat, result.lon, result.display_name, result.address);
                                resultsDiv.style.display = 'none';
                            };
                            resultsDiv.appendChild(item);
                        });
                        resultsDiv.style.display = 'block';
                    } else {
                        resultsDiv.style.display = 'none';
                    }
                });
        }, 500);
    });
    
    function selectCity(lat, lng, displayName, address) {
        const city = address.city || address.town || address.village || displayName.split(',')[0];
        const country = address.country || '';
        
        if (searchType === 'origin') {
            document.getElementById('id_origin_city').value = city;
            document.getElementById('id_origin_country').value = country;
            document.getElementById('id_origin_lat').value = parseFloat(lat).toFixed(6);
            document.getElementById('id_origin_lng').value = parseFloat(lng).toFixed(6);
            setOriginMarker(lat, lng, city);
        } else {
            document.getElementById('id_destination_city').value = city;
            document.getElementById('id_destination_country').value = country;
            document.getElementById('id_destination_lat').value = parseFloat(lat).toFixed(6);
            document.getElementById('id_destination_lng').value = parseFloat(lng).toFixed(6);
            setDestinationMarker(lat, lng, city);
        }
        
        routeMap.setView([lat, lng], 10);
    }
    
    function setOriginMarker(lat, lng, city) {
        if (originMarker) routeMap.removeLayer(originMarker);
        originMarker = L.marker([lat, lng], {draggable: true}).addTo(routeMap)
            .bindPopup(`üìç –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è: ${city}`).openPopup();
        
        originMarker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            updateCoordinates('origin', pos.lat, pos.lng);
        });
        
        updateRouteLine();
    }
    
    function setDestinationMarker(lat, lng, city) {
        if (destMarker) routeMap.removeLayer(destMarker);
        destMarker = L.marker([lat, lng], {draggable: true}).addTo(routeMap)
            .bindPopup(`üìç –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è: ${city}`).openPopup();
        
        destMarker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            updateCoordinates('destination', pos.lat, pos.lng);
        });
        
        updateRouteLine();
    }
    
    function updateCoordinates(type, lat, lng) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(response => response.json())
            .then(data => {
                const address = data.address || {};
                const city = address.city || address.town || address.village || '';
                const country = address.country || '';
                
                if (type === 'origin') {
                    document.getElementById('id_origin_city').value = city;
                    document.getElementById('id_origin_country').value = country;
                    document.getElementById('id_origin_lat').value = lat.toFixed(6);
                    document.getElementById('id_origin_lng').value = lng.toFixed(6);
                } else {
                    document.getElementById('id_destination_city').value = city;
                    document.getElementById('id_destination_country').value = country;
                    document.getElementById('id_destination_lat').value = lat.toFixed(6);
                    document.getElementById('id_destination_lng').value = lng.toFixed(6);
                }
            });
    }
    
    function updateRouteLine() {
        if (routeLine) routeMap.removeLayer(routeLine);
        if (originMarker && destMarker) {
            routeLine = L.polyline([
                [originMarker.getLatLng().lat, originMarker.getLatLng().lng],
                [destMarker.getLatLng().lat, destMarker.getLatLng().lng]
            ], {color: '#667eea', weight: 3, dashArray: '10, 5'}).addTo(routeMap);
            routeMap.fitBounds([originMarker.getLatLng(), destMarker.getLatLng()]);
        }
    }
    
    // –ö–ª—ñ–∫ –ø–æ –∫–∞—Ä—Ç—ñ
    routeMap.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        if (!originMarker || !document.getElementById('id_origin_lat').value) {
            setOriginMarker(lat, lng, '');
            updateCoordinates('origin', lat, lng);
        } else if (!destMarker || !document.getElementById('id_destination_lat').value) {
            setDestinationMarker(lat, lng, '');
            updateCoordinates('destination', lat, lng);
        }
    });
    
    // –ù–∞–≤—ñ–≥–∞—Ü—ñ—è –ø–æ –∫—Ä–æ–∫–∞—Ö
    function nextStep() {
        if (currentStep < 4) {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}-indicator`).classList.remove('active');
            document.getElementById(`step${currentStep}-indicator`).classList.add('completed');
            
            currentStep++;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}-indicator`).classList.add('active');
            
            if (currentStep === 4) {
                updateReview();
            }
        }
    }
    
    function prevStep() {
        if (currentStep > 1) {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}-indicator`).classList.remove('active');
            document.getElementById(`step${currentStep}-indicator`).classList.remove('completed');
            
            currentStep--;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}-indicator`).classList.add('active');
        }
    }
    
    function updateReview() {
        const review = document.getElementById('reviewData');
        review.innerHTML = `
            <p><strong>–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:</strong> ${document.getElementById('id_origin_city').value || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
            <p><strong>–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:</strong> ${document.getElementById('id_destination_city').value || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
            <p><strong>–¢–∏–ø –≤–∞–Ω—Ç–∞–∂—É:</strong> ${document.getElementById('id_cargo_type').value || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
            <p><strong>–í–∞–≥–∞:</strong> ${document.getElementById('id_weight').value || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'} –∫–≥</p>
            <p><strong>–¶—ñ–Ω–∞:</strong> ${document.getElementById('id_price').value || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'} –≥—Ä–Ω</p>
        `;
    }
</script>
{% endblock %}
{% endblock %}
