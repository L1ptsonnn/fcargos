{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}–°—Ç–≤–æ—Ä–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç - FCargos{% endblock %}

{% block extra_css %}
<style>
    .map-selector {
        height: 300px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="text-center py-3">
                        <i class="bi bi-plus-circle" style="font-size: 48px;"></i>
                        <h3 class="mt-2 mb-0">–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –º–∞—Ä—à—Ä—É—Ç</h3>
                    </div>
                </div>
                <div class="card-body p-5">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>–ü—ñ–¥–∫–∞–∑–∫–∞:</strong> –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–∞—Ä—Ç—É –¥–ª—è –≤–∏–±–æ—Ä—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –º—ñ—Å—Ç
                    </div>
                    
                    <div id="routeMap" class="map-selector mb-4"></div>
                    
                    {% crispy form %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ –¥–ª—è –≤–∏–±–æ—Ä—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    const routeMap = L.map('routeMap').setView([50.45, 30.52], 6);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(routeMap);
    
    let originMarker = null;
    let destMarker = null;
    let routeLine = null;
    
    // –§—É–Ω–∫—Ü—ñ—è –ø–æ—à—É–∫—É –º—ñ—Å—Ç–∞
    function searchCity(query, type) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    const address = result.address || {};
                    const city = address.city || address.town || address.village || query;
                    const country = address.country || '';
                    
                    if (type === 'origin') {
                        setOriginPoint(lat, lng, city, country);
                    } else {
                        setDestinationPoint(lat, lng, city, country);
                    }
                }
            });
    }
    
    function setOriginPoint(lat, lng, city, country) {
        if (originMarker) {
            routeMap.removeLayer(originMarker);
        }
        originMarker = L.marker([lat, lng], {draggable: true}).addTo(routeMap)
            .bindPopup('üìç –¢–æ—á–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è').openPopup();
        document.getElementById('id_origin_lat').value = lat.toFixed(6);
        document.getElementById('id_origin_lng').value = lng.toFixed(6);
        document.getElementById('id_origin_city').value = city;
        document.getElementById('id_origin_country').value = country;
        
        originMarker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            updateOriginFromCoordinates(pos.lat, pos.lng);
        });
        
        updateRouteLine();
    }
    
    function setDestinationPoint(lat, lng, city, country) {
        if (destMarker) {
            routeMap.removeLayer(destMarker);
        }
        destMarker = L.marker([lat, lng], {draggable: true}).addTo(routeMap)
            .bindPopup('üìç –¢–æ—á–∫–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è').openPopup();
        document.getElementById('id_destination_lat').value = lat.toFixed(6);
        document.getElementById('id_destination_lng').value = lng.toFixed(6);
        document.getElementById('id_destination_city').value = city;
        document.getElementById('id_destination_country').value = country;
        
        destMarker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            updateDestinationFromCoordinates(pos.lat, pos.lng);
        });
        
        updateRouteLine();
    }
    
    function updateOriginFromCoordinates(lat, lng) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(response => response.json())
            .then(data => {
                const address = data.address || {};
                const city = address.city || address.town || address.village || '';
                const country = address.country || '';
                document.getElementById('id_origin_lat').value = lat.toFixed(6);
                document.getElementById('id_origin_lng').value = lng.toFixed(6);
                document.getElementById('id_origin_city').value = city;
                document.getElementById('id_origin_country').value = country;
            });
        updateRouteLine();
    }
    
    function updateDestinationFromCoordinates(lat, lng) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(response => response.json())
            .then(data => {
                const address = data.address || {};
                const city = address.city || address.town || address.village || '';
                const country = address.country || '';
                document.getElementById('id_destination_lat').value = lat.toFixed(6);
                document.getElementById('id_destination_lng').value = lng.toFixed(6);
                document.getElementById('id_destination_city').value = city;
                document.getElementById('id_destination_country').value = country;
            });
        updateRouteLine();
    }
    
    function updateRouteLine() {
        if (routeLine) {
            routeMap.removeLayer(routeLine);
        }
        if (originMarker && destMarker) {
            routeLine = L.polyline([
                [originMarker.getLatLng().lat, originMarker.getLatLng().lng],
                [destMarker.getLatLng().lat, destMarker.getLatLng().lng]
            ], {color: '#667eea', weight: 3, dashArray: '10, 5'}).addTo(routeMap);
        }
    }
    
    // –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—ñ–≤ –Ω–∞ –∫–∞—Ä—Ç—ñ
    routeMap.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        if (!originMarker) {
            updateOriginFromCoordinates(lat, lng);
            setOriginPoint(lat, lng, '', '');
        } else if (!destMarker) {
            updateDestinationFromCoordinates(lat, lng);
            setDestinationPoint(lat, lng, '', '');
        }
    });
    
    // –ü–æ—à—É–∫ –º—ñ—Å—Ç —á–µ—Ä–µ–∑ –ø–æ–ª—è –≤–≤–æ–¥—É
    document.getElementById('id_origin_city').addEventListener('blur', function() {
        if (this.value && !document.getElementById('id_origin_lat').value) {
            searchCity(this.value, 'origin');
        }
    });
    
    document.getElementById('id_destination_city').addEventListener('blur', function() {
        if (this.value && !document.getElementById('id_destination_lat').value) {
            searchCity(this.value, 'destination');
        }
    });
</script>
{% endblock %}
{% endblock %}

