{% extends 'base.html' %}
{% load static %}

{% block title %}–ì–æ–ª–æ–≤–Ω–∞ - FCargos{% endblock %}

{% block extra_css %}
<style>
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 120px 0 80px;
        position: relative;
        overflow: hidden;
    }
    .hero-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,112C672,96,768,96,864,112C960,128,1056,160,1152,160C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
        background-size: cover;
    }
    .hero-content {
        position: relative;
        z-index: 1;
    }
    .map-container {
        height: 600px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        overflow: hidden;
        margin-top: 50px;
        position: relative;
    }
    .route-card {
        transition: transform 0.3s, box-shadow 0.3s;
        border: none;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .route-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        transition: transform 0.3s;
    }
    .stats-card:hover {
        transform: scale(1.05);
    }
    .animated-icon {
        animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-20px); }
    }
    .route-line {
        stroke: #667eea;
        stroke-width: 3;
        stroke-dasharray: 10, 5;
        animation: dash 20s linear infinite;
    }
    @keyframes dash {
        to {
            stroke-dashoffset: -1000;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container hero-content">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="display-4 fw-bold mb-4">
                    <i class="bi bi-truck animated-icon"></i>
                    FCargos
                </h1>
                <p class="lead mb-4">
                    –°—É—á–∞—Å–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ª–æ–≥—ñ—Å—Ç–∏—á–Ω–∏—Ö –ø–µ—Ä–µ–≤–µ–∑–µ–Ω—å. 
                    –ó'—î–¥–Ω—É—î–º–æ –∫–æ–º–ø–∞–Ω—ñ—ó —Ç–∞ –ø–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫—ñ–≤ –ø–æ –≤—Å—å–æ–º—É —Å–≤—ñ—Ç—É.
                </p>
                {% if not user.is_authenticated %}
                    <a href="{% url 'register' %}" class="btn btn-light btn-lg me-3">
                        <i class="bi bi-person-plus"></i> –ü–æ—á–∞—Ç–∏ –∑–∞—Ä–∞–∑
                    </a>
                    <a href="{% url 'login' %}" class="btn btn-outline-light btn-lg">
                        <i class="bi bi-box-arrow-in-right"></i> –£–≤—ñ–π—Ç–∏
                    </a>
                {% else %}
                    {% if user.role == 'company' %}
                        <a href="{% url 'create_route' %}" class="btn btn-light btn-lg">
                            <i class="bi bi-plus-circle"></i> –°—Ç–≤–æ—Ä–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç
                        </a>
                    {% elif user.role == 'carrier' %}
                        <a href="{% url 'routes_list' %}" class="btn btn-light btn-lg">
                            <i class="bi bi-search"></i> –ó–Ω–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–∏
                        </a>
                    {% endif %}
                {% endif %}
            </div>
            <div class="col-lg-6 text-center">
                <i class="bi bi-globe" style="font-size: 200px; opacity: 0.3;"></i>
            </div>
        </div>
    </div>
</section>

<!-- Stats Section -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="stats-card text-center">
                    <i class="bi bi-map" style="font-size: 48px;"></i>
                    <h3 class="mt-3">{{ routes|length }}</h3>
                    <p class="mb-0">–ê–∫—Ç–∏–≤–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card text-center" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="bi bi-truck" style="font-size: 48px;"></i>
                    <h3 class="mt-3">24/7</h3>
                    <p class="mb-0">–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card text-center" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="bi bi-shield-check" style="font-size: 48px;"></i>
                    <h3 class="mt-3">100%</h3>
                    <p class="mb-0">–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Map Section -->
<section class="py-5">
    <div class="container">
        <h2 class="text-center mb-5">
            <i class="bi bi-globe-americas"></i> –î–∏–Ω–∞–º—ñ—á–Ω–∞ –∫–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç—ñ–≤
        </h2>
        <div class="map-container">
            <div id="worldMap" style="height: 100%; width: 100%;"></div>
        </div>
    </div>
</section>

<!-- Routes List -->
{% if routes %}
<section class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center mb-5">–û—Å—Ç–∞–Ω–Ω—ñ –º–∞—Ä—à—Ä—É—Ç–∏</h2>
        <div class="row">
            {% for route in routes %}
            <div class="col-md-6 col-lg-4">
                <div class="card route-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-geo-alt"></i> {{ route.origin_city }}
                            <i class="bi bi-arrow-right"></i>
                            {{ route.destination_city }}
                        </h5>
                        <p class="card-text">
                            <strong>–¢–∏–ø –≤–∞–Ω—Ç–∞–∂—É:</strong> {{ route.cargo_type }}<br>
                            <strong>–í–∞–≥–∞:</strong> {{ route.weight }} –∫–≥<br>
                            <strong>–¶—ñ–Ω–∞:</strong> {{ route.price }} –≥—Ä–Ω
                        </p>
                        <span class="badge bg-{% if route.status == 'pending' %}warning{% elif route.status == 'in_transit' %}info{% else %}success{% endif %}">
                            {{ route.get_status_display }}
                        </span>
                        <a href="{% url 'route_detail' route.pk %}" class="btn btn-primary btn-sm mt-2">
                            –î–µ—Ç–∞–ª—ñ <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // –û—á—ñ–∫—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DOM —Ç–∞ Leaflet
    document.addEventListener('DOMContentLoaded', function() {
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ Leaflet –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π
        if (typeof L === 'undefined') {
            console.error('Leaflet –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π!');
            document.getElementById('worldMap').innerHTML = '<div class="alert alert-danger m-3">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É.</div>';
            return;
        }
        
        try {
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ —Å–≤—ñ—Ç—É
            const map = L.map('worldMap').setView([50.0, 30.0], 3);
            
            // –î–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–∞–π–ª—ñ–≤ –∫–∞—Ä—Ç–∏
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // –î–∞–Ω—ñ –º–∞—Ä—à—Ä—É—Ç—ñ–≤
            const routesData = JSON.parse('{{ routes_data|escapejs }}');
            const animatedMarkers = {};

            // –î–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –Ω–∞ –∫–∞—Ä—Ç—É –∑ –ø–æ–∫—Ä–∞—â–µ–Ω–∏–º —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–æ–º
            routesData.forEach((route, index) => {
                const origin = [route.origin.lat, route.origin.lng];
                const destination = [route.destination.lat, route.destination.lng];
                
                // –ö–æ–ª—å–æ—Ä–æ–≤—ñ –º–∞—Ä–∫–µ—Ä–∏ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å—Ç–∞—Ç—É—Å—É
                const originIcon = L.divIcon({
                    className: 'route-marker',
                    html: `<div style="background: #198754; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(25, 135, 84, 0.8);"></div>`,
                    iconSize: [20, 20]
                });
                
                const destIcon = L.divIcon({
                    className: 'route-marker',
                    html: `<div style="background: #dc3545; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(220, 53, 69, 0.8);"></div>`,
                    iconSize: [20, 20]
                });
                
                // –ú–∞—Ä–∫–µ—Ä–∏ –∑ –ø–æ–ø–∞–ø–∞–º–∏
                const originMarker = L.marker(origin, {icon: originIcon}).addTo(map)
                    .bindPopup(`
                        <b>üìç ${route.origin.city}</b><br>
                        ${route.origin.country}<br>
                        <small>–¢–∏–ø: ${route.cargo_type}</small>
                    `);
                
                const destMarker = L.marker(destination, {icon: destIcon}).addTo(map)
                    .bindPopup(`
                        <b>üìç ${route.destination.city}</b><br>
                        ${route.destination.country}<br>
                        <small>–¢–∏–ø: ${route.cargo_type}</small>
                    `);
                
                // –õ—ñ–Ω—ñ—è –º–∞—Ä—à—Ä—É—Ç—É –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
                const routeColor = route.status === 'pending' ? '#ffc107' : '#0dcaf0';
                const polyline = L.polyline([origin, destination], {
                    color: routeColor,
                    weight: 4,
                    opacity: 0.8,
                    dashArray: route.status === 'in_transit' ? '10, 5' : null
                }).addTo(map);
                
                // –ê–Ω—ñ–º–∞—Ü—ñ—è —Ä—É—Ö—É –¥–ª—è –∞–∫—Ç–∏–≤–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤
                if (route.status === 'in_transit') {
                    let progress = 0;
                    const animateRoute = () => {
                        if (progress <= 100) {
                            const lat = route.origin.lat + (route.destination.lat - route.origin.lat) * (progress / 100);
                            const lng = route.origin.lng + (route.destination.lng - route.origin.lng) * (progress / 100);
                            
                            if (animatedMarkers[index]) {
                                map.removeLayer(animatedMarkers[index]);
                            }
                            
                            const animatedIcon = L.divIcon({
                                className: 'animated-route-marker',
                                html: `<div style="background: ${routeColor}; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px ${routeColor}; animation: pulse 2s infinite;"></div>`,
                                iconSize: [18, 18]
                            });
                            
                            animatedMarkers[index] = L.marker([lat, lng], {icon: animatedIcon}).addTo(map)
                                .bindPopup(`<b>üöö –í–∞–Ω—Ç–∞–∂ –≤ –¥–æ—Ä–æ–∑—ñ</b><br>–ü—Ä–æ–≥—Ä–µ—Å: ${Math.round(progress)}%`);
                            
                            progress += 1;
                            setTimeout(animateRoute, 150);
                        } else {
                            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é
                            setTimeout(() => {
                                progress = 0;
                                animateRoute();
                            }, 1000);
                        }
                    };
                    
                    animateRoute();
                }
                
                // –î–æ–¥–∞–≤–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –º–∞—Ä—à—Ä—É—Ç –¥–æ –ø–æ–ø–∞–ø—É –ª—ñ–Ω—ñ—ó
                polyline.bindPopup(`
                    <b>${route.origin.city} ‚Üí ${route.destination.city}</b><br>
                    –¢–∏–ø –≤–∞–Ω—Ç–∞–∂—É: ${route.cargo_type}<br>
                    –°—Ç–∞—Ç—É—Å: ${route.status === 'pending' ? '–û—á—ñ–∫—É—î' : '–í –¥–æ—Ä–æ–∑—ñ'}
                `);
            });
    
            // –§—ñ—Ç –±—ñ–≥–æ–∫—Å –¥–ª—è –≤—Å—ñ—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤
            if (routesData.length > 0) {
                const allPoints = [];
                routesData.forEach(route => {
                    allPoints.push([route.origin.lat, route.origin.lng]);
                    allPoints.push([route.destination.lat, route.destination.lng]);
                });
                
                if (allPoints.length > 0) {
                    map.fitBounds(allPoints, {padding: [50, 50]});
                }
            }
        } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Ä—Ç–∏:', error);
            document.getElementById('worldMap').innerHTML = '<div class="alert alert-danger m-3">–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É.</div>';
        }
    });
</script>
{% endblock %}

