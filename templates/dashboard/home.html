{% extends 'base.html' %}
{% load static %}

{% block title %}–ì–æ–ª–æ–≤–Ω–∞ - FCargos{% endblock %}

{% block extra_css %}
<style>
    .hero-section {
        background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 50%, var(--secondary-gradient-start) 100%);
        background-size: 200% 200%;
        animation: gradientShift 8s ease infinite;
        color: white;
        padding: 120px 0 100px;
        position: relative;
        overflow: hidden;
    }
    .hero-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,112C672,96,768,96,864,112C960,128,1056,160,1152,160C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
        background-size: cover;
    }
    .hero-content {
        position: relative;
        z-index: 1;
    }
    .map-container {
        height: 600px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        overflow: hidden;
        margin-top: 50px;
        position: relative;
    }
    .route-card {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        overflow: hidden;
        background: white;
    }
    .route-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 12px 30px rgba(102, 126, 234, 0.25);
        border-left: 4px solid #667eea;
    }
    .route-card .card-body {
        padding: 1.5rem;
    }
    .route-card .card-title {
        color: #333;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    .route-card .card-title i {
        color: #667eea;
        margin: 0 0.5rem;
    }
    .stats-card {
        background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
        background-size: 200% 200%;
        animation: gradientShift 5s ease infinite;
        color: white;
        border-radius: 20px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        transition: var(--transition-base);
        position: relative;
        overflow: hidden;
    }
    .stats-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: shimmer 3s infinite;
    }
    .stats-card:hover {
        transform: translateY(-10px) scale(1.05);
        box-shadow: var(--shadow-xl);
    }
    .animated-icon {
        animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-20px); }
    }
    .route-line {
        stroke: #667eea;
        stroke-width: 3;
        stroke-dasharray: 10, 5;
        animation: dash 20s linear infinite;
    }
    @keyframes dash {
        to {
            stroke-dashoffset: -1000;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container hero-content">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="display-4 fw-bold mb-4">
                    <i class="bi bi-truck animated-icon"></i>
                    FCargos
                </h1>
                <p class="lead mb-4">
                    –°—É—á–∞—Å–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ª–æ–≥—ñ—Å—Ç–∏—á–Ω–∏—Ö –ø–µ—Ä–µ–≤–µ–∑–µ–Ω—å. 
                    –ó'—î–¥–Ω—É—î–º–æ –∫–æ–º–ø–∞–Ω—ñ—ó —Ç–∞ –ø–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫—ñ–≤ –ø–æ –≤—Å—å–æ–º—É —Å–≤—ñ—Ç—É.
                </p>
                {% if not user.is_authenticated %}
                    <a href="{% url 'register' %}" class="btn btn-light btn-lg me-3">
                        <i class="bi bi-person-plus"></i> –ü–æ—á–∞—Ç–∏ –∑–∞—Ä–∞–∑
                    </a>
                    <a href="{% url 'login' %}" class="btn btn-outline-light btn-lg">
                        <i class="bi bi-box-arrow-in-right"></i> –£–≤—ñ–π—Ç–∏
                    </a>
                {% else %}
                    {% if user.role == 'company' %}
                        <a href="{% url 'create_route' %}" 
                           class="btn btn-light btn-lg"
                           hx-get="{% url 'create_route' %}"
                           hx-target="#createRouteModalContent"
                           hx-swap="innerHTML"
                           data-bs-toggle="modal"
                           data-bs-target="#createRouteModal">
                            <i class="bi bi-plus-circle"></i> –°—Ç–≤–æ—Ä–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç
                        </a>
                    {% elif user.role == 'carrier' %}
                        <a href="{% url 'routes_list' %}" class="btn btn-light btn-lg">
                            <i class="bi bi-search"></i> –ó–Ω–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–∏
                        </a>
                    {% endif %}
                {% endif %}
            </div>
            <div class="col-lg-6 text-center">
                <i class="bi bi-globe" style="font-size: 200px; opacity: 0.3;"></i>
            </div>
        </div>
    </div>
</section>

<!-- Stats Section -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="stats-card text-center">
                    <i class="bi bi-map" style="font-size: 48px;"></i>
                    <h3 class="mt-3 stats-number">{{ routes|length }}</h3>
                    <p class="mb-0">–ê–∫—Ç–∏–≤–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card text-center" style="background: linear-gradient(135deg, var(--secondary-gradient-start) 0%, var(--secondary-gradient-end) 100%); background-size: 200% 200%; animation: gradientShift 5s ease infinite;">
                    <i class="bi bi-truck" style="font-size: 48px;"></i>
                    <h3 class="mt-3 stats-number">24/7</h3>
                    <p class="mb-0">–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card text-center" style="background: linear-gradient(135deg, var(--accent-gradient-start) 0%, var(--accent-gradient-end) 100%); background-size: 200% 200%; animation: gradientShift 5s ease infinite;">
                    <i class="bi bi-shield-check" style="font-size: 48px;"></i>
                    <h3 class="mt-3 stats-number">100%</h3>
                    <p class="mb-0">–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Map Section -->
<section class="py-5">
    <div class="container">
        <h2 class="text-center mb-5">
            <i class="bi bi-globe-americas"></i> –î–∏–Ω–∞–º—ñ—á–Ω–∞ –∫–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç—ñ–≤
        </h2>
        <div class="map-container">
            <div id="worldMap" style="height: 100%; width: 100%;"></div>
        </div>
    </div>
</section>

<!-- Routes List -->
{% if routes %}
<section class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center mb-4">–û—Å—Ç–∞–Ω–Ω—ñ –º–∞—Ä—à—Ä—É—Ç–∏</h2>
        <div class="routes-carousel-container" style="position: relative; max-width: 500px; margin: 0 auto;">
            <button class="carousel-arrow prev-arrow" onclick="window.prevRoute && window.prevRoute()" id="prevRouteBtn">
                <i class="bi bi-chevron-left"></i>
            </button>
            <div class="routes-carousel" id="routesCarousel">
                {% for route in routes %}
                <div class="route-carousel-item">
                    <div class="card route-card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="bi bi-geo-alt"></i> {{ route.origin_city }}
                                <i class="bi bi-arrow-right"></i>
                                {{ route.destination_city }}
                            </h5>
                            <p class="card-text">
                                <strong><i class="bi bi-building"></i> –ö–æ–º–ø–∞–Ω—ñ—è:</strong> 
                                <a href="{% url 'user_profile' route.company.pk %}" class="text-decoration-none">
                                    {{ route.company.company_name|default:route.company.username }}
                                </a><br>
                                <strong>–¢–∏–ø –≤–∞–Ω—Ç–∞–∂—É:</strong> {{ route.cargo_type }}<br>
                                <strong>–í–∞–≥–∞:</strong> {{ route.weight }} –∫–≥<br>
                                <strong>–¶—ñ–Ω–∞:</strong> {{ route.price }} –≥—Ä–Ω
                            </p>
                            <span class="badge bg-{% if route.status == 'pending' %}warning{% elif route.status == 'in_transit' %}info{% else %}success{% endif %}">
                                {{ route.get_status_display }}
                            </span>
                            <a href="{% url 'route_detail' route.pk %}" class="btn btn-primary btn-sm mt-2">
                                –î–µ—Ç–∞–ª—ñ <i class="bi bi-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button class="carousel-arrow next-arrow" onclick="window.nextRoute && window.nextRoute()" id="nextRouteBtn">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
</section>

<style>
    .routes-carousel-container {
        padding: 0 50px;
    }
    
    .routes-carousel {
        display: flex;
        gap: 1.5rem;
        overflow: hidden;
        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: transform;
    }
    
    .route-carousel-item {
        flex: 0 0 100%;
        min-width: 100%;
        display: flex;
        justify-content: center;
    }
    
    .route-carousel-item .card {
        max-width: 400px;
        width: 100%;
    }
    
    .carousel-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: white;
        border: 2px solid #667eea;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.25);
        cursor: pointer;
        z-index: 10;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 1.3rem;
        color: #667eea;
        font-weight: bold;
    }
    
    .carousel-arrow:hover:not(:disabled) {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        transform: translateY(-50%) scale(1.15);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        border-color: transparent;
    }
    
    .carousel-arrow:active:not(:disabled) {
        transform: translateY(-50%) scale(1.05);
    }
    
    .carousel-arrow:disabled {
        opacity: 0.25;
        cursor: not-allowed;
        background: #f8f9fa;
        border-color: #dee2e6;
        color: #adb5bd;
    }
    
    .carousel-arrow:disabled:hover {
        background: #f8f9fa;
        color: #adb5bd;
        transform: translateY(-50%);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .prev-arrow {
        left: 0;
    }
    
    .next-arrow {
        right: 0;
    }
    
</style>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∫–∞—Ä—É—Å–µ–ª—ñ –º–∞—Ä—à—Ä—É—Ç—ñ–≤
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö
    if (typeof window.currentRouteIndex === 'undefined') {
        window.currentRouteIndex = 0;
    }
    if (typeof window.routesData === 'undefined') {
        window.routesData = [];
    }
    
    {% if routes %}
    // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤
    try {
        window.routesData = [
            {% for route in routes %}
            {
                id: {{ route.id }},
                origin: '{{ route.origin_city|escapejs }}',
                destination: '{{ route.destination_city|escapejs }}',
                cargo: '{{ route.cargo_type|escapejs }}',
                weight: {{ route.weight }},
                price: {{ route.price }},
                status: '{{ route.status|escapejs }}'
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –¥–∞–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤:', e);
        window.routesData = [];
    }
    {% endif %}
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–∞—Ä—É—Å–µ–ª—ñ –∑ –ø–æ–∫—Ä–∞—â–µ–Ω–æ—é –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
    window.updateCarousel = function() {
        try {
            const carousel = document.getElementById('routesCarousel');
            if (!carousel) {
                console.warn('–ö–∞—Ä—É—Å–µ–ª—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            if (!window.routesData || window.routesData.length === 0) {
                // –Ø–∫—â–æ –Ω–µ–º–∞—î –º–∞—Ä—à—Ä—É—Ç—ñ–≤, —Ö–æ–≤–∞—î–º–æ —Å—Ç—Ä—ñ–ª–∫–∏
                const prevBtn = document.getElementById('prevRouteBtn');
                const nextBtn = document.getElementById('nextRouteBtn');
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
                return;
            }
            
            const maxIndex = window.routesData.length - 1;
            window.currentRouteIndex = Math.max(0, Math.min(window.currentRouteIndex, maxIndex));
            
            const translateX = -(window.currentRouteIndex * 100);
            carousel.style.transform = 'translateX(' + translateX + '%)';
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫
            const prevBtn = document.getElementById('prevRouteBtn');
            const nextBtn = document.getElementById('nextRouteBtn');
            if (prevBtn) {
                prevBtn.disabled = window.currentRouteIndex === 0;
                prevBtn.style.display = window.routesData.length <= 1 ? 'none' : 'flex';
            }
            if (nextBtn) {
                nextBtn.disabled = window.currentRouteIndex >= maxIndex || window.routesData.length <= 1;
                nextBtn.style.display = window.routesData.length <= 1 ? 'none' : 'flex';
            }
        } catch (e) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–∞—Ä—É—Å–µ–ª—ñ:', e);
        }
    };
    
    // –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É
    window.prevRoute = function() {
        try {
            if (!window.routesData || window.routesData.length === 0) {
                return;
            }
            
            if (window.currentRouteIndex > 0) {
                window.currentRouteIndex--;
                window.updateCarousel();
            }
        } catch (e) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –¥–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É:', e);
        }
    };
    
    // –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É
    window.nextRoute = function() {
        try {
            if (!window.routesData || window.routesData.length === 0) {
                return;
            }
            
            const maxIndex = window.routesData.length - 1;
            if (window.currentRouteIndex < maxIndex) {
                window.currentRouteIndex++;
                window.updateCarousel();
            }
        } catch (e) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É:', e);
        }
    };
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—É—Å–µ–ª—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    (function() {
        function initCarousel() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(window.updateCarousel, 100);
                });
            } else {
                setTimeout(window.updateCarousel, 100);
            }
        }
        
        // –î–æ–¥–∞—î–º–æ fallback –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        initCarousel();
        
        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –Ω–∞ –∫–Ω–æ–ø–∫–∏ —è–∫ —Ä–µ–∑–µ—Ä–≤
        setTimeout(function() {
            const prevBtn = document.getElementById('prevRouteBtn');
            const nextBtn = document.getElementById('nextRouteBtn');
            
            if (prevBtn && !prevBtn.hasAttribute('data-handler-attached')) {
                prevBtn.setAttribute('data-handler-attached', 'true');
                prevBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (window.prevRoute) {
                        window.prevRoute();
                    }
                });
            }
            
            if (nextBtn && !nextBtn.hasAttribute('data-handler-attached')) {
                nextBtn.setAttribute('data-handler-attached', 'true');
                nextBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (window.nextRoute) {
                        window.nextRoute();
                    }
                });
            }
        }, 500);
    })();
</script>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // –ü–æ–∫—Ä–∞—â–µ–Ω–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
    function initWorldMap() {
        const mapElement = document.getElementById('worldMap');
        if (!mapElement) {
            console.warn('–ï–ª–µ–º–µ–Ω—Ç –∫–∞—Ä—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ Leaflet –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π –∑ –ø–æ–≤—Ç–æ—Ä–Ω–∏–º–∏ —Å–ø—Ä–æ–±–∞–º–∏
        if (typeof L === 'undefined') {
            console.warn('Leaflet —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π, —á–µ–∫–∞—î–º–æ...');
            setTimeout(function() {
                if (typeof L !== 'undefined') {
                    initWorldMap();
                } else {
                    mapElement.innerHTML = '<div class="alert alert-warning m-3"><i class="bi bi-exclamation-triangle"></i> –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∫–∞—Ä—Ç–∏. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É.</div>';
                }
            }, 500);
            return;
        }
        
        try {
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–∏–º–∏–π
            if (mapElement.offsetWidth === 0 || mapElement.offsetHeight === 0) {
                setTimeout(initWorldMap, 200);
                return;
            }
            
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ —Å–≤—ñ—Ç—É
            const map = L.map('worldMap', {
                zoomControl: true,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                boxZoom: true
            }).setView([50.0, 30.0], 3);
            
            // –î–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–∞–π–ª—ñ–≤ –∫–∞—Ä—Ç–∏ –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
            const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
                errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5FcnJvcjwvdGV4dD48L3N2Zz4='
            });
            
            tileLayer.addTo(map);
            
            // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞–π–ª—ñ–≤
            tileLayer.on('tileerror', function(error, tile) {
                console.warn('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞–π–ª—É:', error);
            });

            // –î–∞–Ω—ñ –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é
            let routesData = [];
            try {
                const routesDataStr = '{{ routes_data|escapejs }}';
                if (routesDataStr && routesDataStr !== 'null' && routesDataStr.trim() !== '') {
                    routesData = JSON.parse(routesDataStr);
                }
            } catch (e) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É –¥–∞–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤:', e);
                routesData = [];
            }
            
            const animatedMarkers = {};

            // –î–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –Ω–∞ –∫–∞—Ä—Ç—É –∑ –ø–æ–∫—Ä–∞—â–µ–Ω–∏–º —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–æ–º
            routesData.forEach(function(route, index) {
                try {
                    // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –º–∞—Ä—à—Ä—É—Ç—É
                    if (!route.origin || !route.destination || 
                        !route.origin.lat || !route.origin.lng ||
                        !route.destination.lat || !route.destination.lng) {
                        console.warn('–ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –º–∞—Ä—à—Ä—É—Ç ' + index + ': –Ω–µ–≤–∞–ª—ñ–¥–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏');
                        return;
                    }
                    
                    const originLat = parseFloat(route.origin.lat);
                    const originLng = parseFloat(route.origin.lng);
                    const destLat = parseFloat(route.destination.lat);
                    const destLng = parseFloat(route.destination.lng);
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –≤–∞–ª—ñ–¥–Ω—ñ
                    if (isNaN(originLat) || isNaN(originLng) || isNaN(destLat) || isNaN(destLng)) {
                        console.warn('–ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –º–∞—Ä—à—Ä—É—Ç ' + index + ': –Ω–µ–≤–∞–ª—ñ–¥–Ω—ñ —á–∏—Å–ª–æ–≤—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏');
                        return;
                    }
                    
                    const origin = [originLat, originLng];
                    const destination = [destLat, destLng];
                    
                    // –ö–æ–ª—å–æ—Ä–æ–≤—ñ –º–∞—Ä–∫–µ—Ä–∏ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å—Ç–∞—Ç—É—Å—É
                    const originIcon = L.divIcon({
                        className: 'route-marker',
                        html: '<div style="background: #198754; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(25, 135, 84, 0.8);"></div>',
                        iconSize: [20, 20]
                    });
                    
                    const destIcon = L.divIcon({
                        className: 'route-marker',
                        html: '<div style="background: #dc3545; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(220, 53, 69, 0.8);"></div>',
                        iconSize: [20, 20]
                    });
                
                    // –ú–∞—Ä–∫–µ—Ä–∏ –∑ –ø–æ–ø–∞–ø–∞–º–∏
                    const originCity = route.origin.city || '–ù–µ–≤—ñ–¥–æ–º–æ';
                    const originCountry = route.origin.country || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
                    const destCity = route.destination.city || '–ù–µ–≤—ñ–¥–æ–º–æ';
                    const destCountry = route.destination.country || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
                    const cargoType = route.cargo_type || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
                    
                    const originMarker = L.marker(origin, {icon: originIcon}).addTo(map)
                        .bindPopup(
                            '<b>üìç ' + originCity + '</b><br>' +
                            originCountry + '<br>' +
                            '<small>–¢–∏–ø: ' + cargoType + '</small>'
                        );
                    
                    const destMarker = L.marker(destination, {icon: destIcon}).addTo(map)
                        .bindPopup(
                            '<b>üìç ' + destCity + '</b><br>' +
                            destCountry + '<br>' +
                            '<small>–¢–∏–ø: ' + cargoType + '</small>'
                        );
                    
                    // –õ—ñ–Ω—ñ—è –º–∞—Ä—à—Ä—É—Ç—É –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
                    const routeColor = route.status === 'pending' ? '#ffc107' : '#0dcaf0';
                    const polyline = L.polyline([origin, destination], {
                        color: routeColor,
                        weight: 4,
                        opacity: 0.8,
                        dashArray: route.status === 'in_transit' ? '10, 5' : null
                    }).addTo(map);
                
                    // –ê–Ω—ñ–º–∞—Ü—ñ—è —Ä—É—Ö—É –¥–ª—è –∞–∫—Ç–∏–≤–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤
                    if (route.status === 'in_transit') {
                        let progress = 0;
                        const animateRoute = function() {
                            if (progress <= 100) {
                                const lat = originLat + (destLat - originLat) * (progress / 100);
                                const lng = originLng + (destLng - originLng) * (progress / 100);
                                
                                if (animatedMarkers[index]) {
                                    map.removeLayer(animatedMarkers[index]);
                                }
                                
                                const animatedIcon = L.divIcon({
                                    className: 'animated-route-marker',
                                    html: '<div style="background: ' + routeColor + '; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px ' + routeColor + '; animation: pulse 2s infinite;"></div>',
                                    iconSize: [18, 18]
                                });
                                
                                animatedMarkers[index] = L.marker([lat, lng], {icon: animatedIcon}).addTo(map)
                                    .bindPopup('<b>üöö –í–∞–Ω—Ç–∞–∂ –≤ –¥–æ—Ä–æ–∑—ñ</b><br>–ü—Ä–æ–≥—Ä–µ—Å: ' + Math.round(progress) + '%');
                                
                                progress += 1;
                                setTimeout(animateRoute, 150);
                            } else {
                                // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é
                                setTimeout(function() {
                                    progress = 0;
                                    animateRoute();
                                }, 1000);
                            }
                        };
                        
                        animateRoute();
                    }
                    
                    // –î–æ–¥–∞–≤–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –º–∞—Ä—à—Ä—É—Ç –¥–æ –ø–æ–ø–∞–ø—É –ª—ñ–Ω—ñ—ó
                    polyline.bindPopup(
                        '<b>' + (route.origin.city || '–ù–µ–≤—ñ–¥–æ–º–æ') + ' ‚Üí ' + (route.destination.city || '–ù–µ–≤—ñ–¥–æ–º–æ') + '</b><br>' +
                        '–¢–∏–ø –≤–∞–Ω—Ç–∞–∂—É: ' + (route.cargo_type || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ') + '<br>' +
                        '–°—Ç–∞—Ç—É—Å: ' + (route.status === 'pending' ? '–û—á—ñ–∫—É—î' : '–í –¥–æ—Ä–æ–∑—ñ')
                    );
                } catch (e) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É ' + index + ' –Ω–∞ –∫–∞—Ä—Ç—É:', e);
                }
            });
    
            // –§—ñ—Ç –±—ñ–≥–æ–∫—Å –¥–ª—è –≤—Å—ñ—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
            try {
                if (routesData.length > 0) {
                    const allPoints = [];
                    routesData.forEach(function(route) {
                        try {
                            if (route.origin && route.origin.lat && route.origin.lng &&
                                route.destination && route.destination.lat && route.destination.lng) {
                                const originLat = parseFloat(route.origin.lat);
                                const originLng = parseFloat(route.origin.lng);
                                const destLat = parseFloat(route.destination.lat);
                                const destLng = parseFloat(route.destination.lng);
                                
                                if (!isNaN(originLat) && !isNaN(originLng) && 
                                    !isNaN(destLat) && !isNaN(destLng)) {
                                    allPoints.push([originLat, originLng]);
                                    allPoints.push([destLat, destLng]);
                                }
                            }
                        } catch (e) {
                            console.warn('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ—á–∫–∏ –¥–æ bounds:', e);
                        }
                    });
                    
                    if (allPoints.length > 0) {
                        map.fitBounds(allPoints, {padding: [50, 50]});
                    } else {
                        // –Ø–∫—â–æ –Ω–µ–º–∞—î –≤–∞–ª—ñ–¥–Ω–∏—Ö —Ç–æ—á–æ–∫, –ø–æ–∫–∞–∑—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –≤–∏–¥
                        map.setView([50.0, 30.0], 3);
                    }
                } else {
                    // –Ø–∫—â–æ –Ω–µ–º–∞—î –º–∞—Ä—à—Ä—É—Ç—ñ–≤, –ø–æ–∫–∞–∑—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –≤–∏–¥
                    map.setView([50.0, 30.0], 3);
                }
            } catch (e) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è bounds –∫–∞—Ä—Ç–∏:', e);
            }
        } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Ä—Ç–∏:', error);
            const mapElement = document.getElementById('worldMap');
            if (mapElement) {
                mapElement.innerHTML = '<div class="alert alert-danger m-3"><i class="bi bi-exclamation-triangle"></i> –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏. <a href="javascript:location.reload()" class="alert-link">–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É</a></div>';
            }
        }
    }
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∫–∞—Ä—Ç—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initWorldMap, 300);
        });
    } else {
        setTimeout(initWorldMap, 300);
    }
</script>
{% endblock %}

